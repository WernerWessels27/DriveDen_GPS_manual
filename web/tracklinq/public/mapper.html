<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Course Mapper</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial; }
    .app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    .panel { padding: 12px; overflow: auto; border-right: 1px solid #e5e7eb; background: #fafafa; }
    fieldset { border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 12px; }
    legend { padding: 0 6px; font-weight: 600; }
    label { display: block; font-size: 12px; color: #374151; margin: 6px 0 4px; }
    input, select { width: 100%; box-sizing: border-box; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px; font: inherit; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .toolbar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .tool { cursor: pointer; padding: 8px; border: 1px solid #d1d5db; border-radius: 10px; background: #fff; display: flex; align-items: center; gap: 8px; justify-content: center; }
    .tool.active { outline: 2px solid #2563eb; box-shadow: 0 0 0 2px #93c5fd inset; }
    .pill { font-size: 12px; background: #eef2ff; color: #3730a3; padding: 2px 6px; border-radius: 999px; border: 1px solid #c7d2fe; }
    .minor { font-size: 12px; color: #6b7280; }
    #map { width: 100%; height: 100%; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { font-size: 11px; padding: 4px 8px; border: 1px dashed #d1d5db; border-radius: 999px; background: #fff; }
    .btn { cursor: pointer; padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: #111827; color: #fff; font-weight: 600; }
    .btn.secondary { background: #fff; color: #111827; }
    .btn.warn { background: #7c2d12; }
    .section-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .json-box { white-space: pre; background: #0b1020; color: #c7e1ff; padding: 8px; border-radius: 8px; overflow: auto; font-size: 12px; max-height: 220px; }
    .hr { height: 1px; background: #e5e7eb; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <fieldset>
        <legend>Course</legend>
        <label>Course Name</label>
        <input id="courseName" placeholder="Silver Lakes" />
        <div class="row">
          <div>
            <label>Course ID</label>
            <input id="courseId" placeholder="SLK" maxlength="8" />
          </div>
          <div>
            <label>Club PIN (10 chars)</label>
            <input id="clubPin" placeholder="SLK1234567" maxlength="10" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Total Holes</label>
            <select id="holesCount">
              <option>18</option>
              <option>9</option>
            </select>
          </div>
          <div>
            <label>Google Maps API Key</label>
            <input id="gmapKey" placeholder="YOUR_GOOGLE_MAPS_API_KEY" />
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Hole</legend>
        <div class="row">
          <div>
            <label>Hole #</label>
            <input id="holeNumber" type="number" min="1" max="18" value="1" />
          </div>
          <div>
            <label>Par</label>
            <input id="holePar" type="number" min="3" max="6" value="4" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Stroke</label>
            <input id="holeStroke" type="number" min="1" max="18" value="7" />
          </div>
          <div>
            <label>Elevation sampling</label>
            <select id="elevMode">
              <option value="on">On (recommended)</option>
              <option value="off">Off</option>
            </select>
          </div>
        </div>
        <div class="minor">Click the map to drop the currently selected pin. Elevation (m) is auto-filled.</div>
      </fieldset>

      <fieldset>
        <legend>Pin Tools</legend>
        <div class="toolbar" id="tools"></div>
        <div class="hr"></div>
        <div class="chips" id="currentPins"></div>
        <div class="section-actions" style="margin-top:10px">
          <button class="btn secondary" id="undoBtn">Undo last pin</button>
          <button class="btn warn" id="clearHole">Clear hole pins</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Data</legend>
        <div class="section-actions">
          <button class="btn" id="exportBtn">Export hole JSON</button>
          <button class="btn secondary" id="exportCourseBtn">Export full course JSON</button>
          <input type="file" id="importFile" accept="application/json" />
        </div>
        <label style="margin-top:8px">Preview</label>
        <div class="json-box" id="preview"></div>
      </fieldset>

      <div class="minor">Notes:
        <ul>
          <li>Pin keys match <span class="pill">gps.html</span> expectations: <b>TEE</b>, <b>FRONT</b>, <b>MID</b>, <b>BACK</b>, <b>TOILET</b>, <b>TAPS</b>, <b>STAKE_WHITE</b>, <b>STAKE_RED</b>, <b>STAKE_YELLOW</b>.</li>
          <li>Enable <b>Maps JavaScript API</b> and <b>Elevation API</b> for elevation sampling.</li>
        </ul>
      </div>
    </aside>
    <main id="map"></main>
  </div>

  <script>
    // --- Marker icon factory (simple SVG data URIs) ---
    const pinSVG = (fill = '#2563eb', glyph = '') => {
      const encoded = encodeURIComponent(`<?xml version="1.0"?>
        <svg xmlns='http://www.w3.org/2000/svg' width='40' height='56' viewBox='0 0 40 56'>
          <defs>
            <filter id='s' x='-50%' y='-50%' width='200%' height='200%'>
              <feDropShadow dx='0' dy='2' stdDeviation='2' flood-color='rgba(0,0,0,0.25)' />
            </filter>
          </defs>
          <path filter='url(#s)' d='M20 2c9.39 0 17 7.61 17 17 0 12.75-17 33-17 33S3 31.75 3 19C3 9.61 10.61 2 20 2Z' fill='${fill}'/>
          ${glyph}
        </svg>`);
      return `data:image/svg+xml;charset=UTF-8,${encoded}`;
    };

    const glyphCircle = (char) => `<circle cx='20' cy='20' r='9' fill='white'/>
      <text x='20' y='24' text-anchor='middle' font-family='Arial' font-size='12' font-weight='700' fill='#111'>${char}</text>`;
    const glyphWC = () => `<path d='M14 26h2l1-6 1 6h2l-2-10h-2l-2 10Zm8 0h2v-4h2v4h2V16h-2v4h-2v-4h-2v10Z' fill='white'/>`;
    const glyphTap = () => `<path d='M10 18h10v-2h2v-2h8v2h-6v2h-4v4h4v2h-8v-2h2v-4h-8v-2h0Z' fill='white'/>`;

    const ICONS = {
      TEE: pinSVG('#16a34a', glyphCircle('T')),
      FRONT: pinSVG('#05b6d3', glyphCircle('F')),
      MID: pinSVG('#22c55e', glyphCircle('M')),
      BACK: pinSVG('#ef4444', glyphCircle('B')),
      TOILET: pinSVG('#6b7280', glyphWC()),
      TAPS: pinSVG('#0ea5e9', glyphTap()),
      STAKE_WHITE: pinSVG('#ffffff', ''),
      STAKE_RED: pinSVG('#ef4444', ''),
      STAKE_YELLOW: pinSVG('#fbbf24', ''),
    };

    const TOOL_ORDER = [
      'TEE','FRONT','MID','BACK','TOILET','TAPS','STAKE_WHITE','STAKE_RED','STAKE_YELLOW'
    ];

    // Maintain state
    let map, elevService, activeTool = 'TEE', markers = [], holeData = {}, courseData = {
      meta: { name:"", id:"", pin:"", holes:18 },
      holes: {}
    };

    // Build tool buttons
    const toolsEl = document.getElementById('tools');
    TOOL_ORDER.forEach(key => {
      const btn = document.createElement('button');
      btn.className = 'tool';
      btn.dataset.tool = key;
      btn.innerHTML = `<img alt='' width='18' height='24' src='${ICONS[key]}'/> <span>${key.replace('STAKE_','STAKE ')}</span>`;
      btn.addEventListener('click', () => setActiveTool(key));
      toolsEl.appendChild(btn);
    });
    function setActiveTool(tool){ activeTool = tool; [...toolsEl.children].forEach(b=>b.classList.toggle('active', b.dataset.tool===tool)); }
    setActiveTool('TEE');

    // Map init on demand so we can inject key from UI
    let mapsLoaded = false;
    function ensureGoogleLoaded(){
      if (mapsLoaded) return Promise.resolve();
      const key = document.getElementById('gmapKey').value.trim();
      if(!key){ alert('Enter your Google Maps API key, then click on map area to load.'); throw new Error('No key'); }
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=maps,marker&v=weekly`;
        s.async = true; s.defer = true;
        s.onload = ()=>{ mapsLoaded=true; initMap(); resolve(); };
        s.onerror = (e)=> reject(e);
        document.head.appendChild(s);
      });
    }

    function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -25.746, lng: 28.229 }, // Pretoria default
        zoom: 15,
        mapTypeId: 'satellite',
        tilt: 0,
      });
      elevService = new google.maps.ElevationService();

      map.addListener('click', async (e) => {
        const pos = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        const elevOn = document.getElementById('elevMode').value === 'on';
        let elevation = null;
        if (elevOn && elevService){
          try{
            const res = await elevService.getElevationForLocations({ locations: [pos] });
            elevation = res.results?.[0]?.elevation ?? null;
          }catch(err){ console.warn('Elevation failed', err); }
        }
        addPinToHole(activeTool, pos, elevation);
      });
    }

    // Add/Remove Pins
    function addPinToHole(kind, position, elevation){
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      const par = parseInt(document.getElementById('holePar').value,10);
      const stroke = parseInt(document.getElementById('holeStroke').value,10);

      if(!courseData.holes[holeNo]) courseData.holes[holeNo] = { par, stroke, pins: {} };
      courseData.holes[holeNo].par = par; // keep updated
      courseData.holes[holeNo].stroke = stroke;

      const pin = { kind, lat: position.lat, lng: position.lng, elev_m: elevation!==null? Math.round(elevation): null, ts: Date.now() };

      // Unique pins (TEE/FRONT/MID/BACK/TOILET) -> single item; others allow multiple
      const singular = ['TEE','FRONT','MID','BACK','TOILET'];
      if(singular.includes(kind)){
        courseData.holes[holeNo].pins[kind] = pin;
      } else {
        if(!courseData.holes[holeNo].pins[kind]) courseData.holes[holeNo].pins[kind] = [];
        courseData.holes[holeNo].pins[kind].push(pin);
      }

      // Render marker
      const m = new google.maps.marker.AdvancedMarkerElement({
        map,
        position,
        content: (()=>{ const img = document.createElement('img'); img.src = ICONS[kind]; img.style.width='28px'; img.style.height='40px'; return img; })(),
        title: kind
      });
      m.__meta = { holeNo, kind };
      markers.push(m);

      refreshPinsUI();
      refreshPreview();
    }

    function refreshPinsUI(){
      const el = document.getElementById('currentPins');
      el.innerHTML = '';
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      const hole = courseData.holes[holeNo];
      if(!hole){ return; }
      const pins = hole.pins || {};
      const entries = Object.entries(pins);
      entries.forEach(([k,v])=>{
        const count = Array.isArray(v) ? v.length : (v?1:0);
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = `${k}: ${count}`;
        el.appendChild(chip);
      });
    }

    function refreshPreview(){
      // meta
      courseData.meta.name = document.getElementById('courseName').value.trim();
      courseData.meta.id = document.getElementById('courseId').value.trim();
      courseData.meta.pin = document.getElementById('clubPin').value.trim();
      courseData.meta.holes = parseInt(document.getElementById('holesCount').value,10);

      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      // lightly sort keys for stability
      const sorted = JSON.parse(JSON.stringify(courseData));
      sorted.holes = Object.fromEntries(Object.entries(sorted.holes).sort((a,b)=>a[0]-b[0]));
      document.getElementById('preview').textContent = JSON.stringify({
        course: sorted.meta,
        holes: sorted.holes,
      }, null, 2);
    }

    // Buttons
    document.getElementById('undoBtn').addEventListener('click', ()=>{
      // remove last marker for current hole
      for(let i=markers.length-1;i>=0;i--){
        const m = markers[i];
        const holeNo = parseInt(document.getElementById('holeNumber').value,10);
        if(m.__meta?.holeNo === holeNo){
          const kind = m.__meta.kind;
          m.map = null; // remove from map
          markers.splice(i,1);
          const pins = courseData.holes[holeNo]?.pins || {};
          if(Array.isArray(pins[kind])) pins[kind].pop(); else pins[kind] = undefined;
          refreshPinsUI(); refreshPreview();
          break;
        }
      }
    });

    document.getElementById('clearHole').addEventListener('click', ()=>{
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      markers = markers.filter(m=>{
        if(m.__meta?.holeNo === holeNo){ m.map = null; return false; }
        return true;
      });
      if(courseData.holes[holeNo]) courseData.holes[holeNo].pins = {};
      refreshPinsUI(); refreshPreview();
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      const hole = courseData.holes[holeNo] || { par: null, stroke: null, pins:{} };
      const payload = { course: courseData.meta, hole: { number: holeNo, ...hole } };
      downloadJSON(payload, `${courseData.meta.id || 'COURSE'}-H${holeNo}.json`);
    });

    document.getElementById('exportCourseBtn').addEventListener('click', ()=>{
      const payload = { course: courseData.meta, holes: courseData.holes };
      downloadJSON(payload, `${courseData.meta.id || 'COURSE'}-course.json`);
    });

    document.getElementById('importFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const txt = await file.text();
      try{
        const json = JSON.parse(txt);
        if(json.course && json.holes){
          courseData.meta = json.course;
          courseData.holes = json.holes;
        } else if(json.course && json.hole){
          // merge single-hole import
          courseData.meta = json.course;
          courseData.holes[json.hole.number] = { par: json.hole.par, stroke: json.hole.stroke, pins: json.hole.pins };
        } else {
          alert('Unrecognized JSON shape');
          return;
        }
        // update form fields
        document.getElementById('courseName').value = courseData.meta.name || '';
        document.getElementById('courseId').value = courseData.meta.id || '';
        document.getElementById('clubPin').value = courseData.meta.pin || '';
        document.getElementById('holesCount').value = String(courseData.meta.holes || 18);
        // clear markers then re-render current hole
        markers.forEach(m=>m.map=null); markers=[];
        refreshPinsUI(); refreshPreview();
        alert('Import successful. Switch holes to view/edit specific hole pins.');
      }catch(err){
        console.error(err); alert('Invalid JSON');
      }
    });

    // Update JSON preview on inputs change
    ['courseName','courseId','clubPin','holesCount','holeNumber','holePar','holeStroke'].forEach(id=>{
      document.getElementById(id).addEventListener('input', ()=>{ refreshPreview(); redrawHoleMarkers(); });
    });

    function redrawHoleMarkers(){
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      // remove all then add for selected hole
      markers.forEach(m=>m.map=null); markers=[];
      const hole = courseData.holes[holeNo]; if(!hole) { refreshPinsUI(); return; }
      const pins = hole.pins || {};
      for(const [k,v] of Object.entries(pins)){
        if(Array.isArray(v)) v.forEach(p=>renderMarker(k,p, holeNo));
        else if(v) renderMarker(k,v, holeNo);
      }
      refreshPinsUI();
    }

    function renderMarker(kind, p, holeNo){
      const m = new google.maps.marker.AdvancedMarkerElement({
        map,
        position: { lat: p.lat, lng: p.lng },
        content: (()=>{ const img=document.createElement('img'); img.src=ICONS[kind]; img.style.width='28px'; img.style.height='40px'; return img; })(),
        title: kind
      });
      m.__meta = { holeNo, kind };
      markers.push(m);
    }

    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // Lazy-load Maps when the user first interacts with the map pane
    document.getElementById('map').addEventListener('click', ()=>{ if(!mapsLoaded) ensureGoogleLoaded().catch(()=>{}); }, { once: true });
  </script>
</body>
</html>
