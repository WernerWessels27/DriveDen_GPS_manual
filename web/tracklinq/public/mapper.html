<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Course Mapper</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial; }
    .app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    .panel { padding: 12px; overflow: auto; border-right: 1px solid #e5e7eb; background: #fafafa; }
    fieldset { border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 12px; }
    legend { padding: 0 6px; font-weight: 600; }
    label { display: block; font-size: 12px; color: #374151; margin: 6px 0 4px; }
    input, select { width: 100%; box-sizing: border-box; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px; font: inherit; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .toolbar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .tool { cursor: pointer; padding: 8px; border: 1px solid #d1d5db; border-radius: 10px; background: #fff; display: flex; align-items: center; gap: 8px; justify-content: center; }
    .tool.active { outline: 2px solid #2563eb; box-shadow: 0 0 0 2px #93c5fd inset; }
    .minor { font-size: 12px; color: #6b7280; }
    #map { width: 100%; height: 100%; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { font-size: 11px; padding: 4px 8px; border: 1px dashed #d1d5db; border-radius: 999px; background: #fff; }
    .btn { cursor: pointer; padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: #111827; color: #fff; font-weight: 600; }
    .btn.secondary { background: #fff; color: #111827; }
    .btn.warn { background: #7c2d12; }
    .section-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .json-box { white-space: pre; background: #0b1020; color: #c7e1ff; padding: 8px; border-radius: 8px; overflow: auto; font-size: 12px; max-height: 220px; }
    .hr { height: 1px; background: #e5e7eb; margin: 10px 0; }
    .legend { position: absolute; z-index: 1000; right: 10px; top: 10px; background: #fff; border-radius: 8px; padding: 6px 8px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <fieldset>
        <legend>Course</legend>
        <label>Course Name</label>
        <input id="courseName" placeholder="Silver Lakes" />
        <div class="row">
          <div>
            <label>Course ID</label>
            <input id="courseId" placeholder="SLK" maxlength="8" />
          </div>
          <div>
            <label>Club PIN (10 chars)</label>
            <input id="clubPin" placeholder="SLK1234567" maxlength="10" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Total Holes</label>
            <select id="holesCount">
              <option>9</option>
              <option selected>18</option>
              <option>27</option>
              <option>36</option>
            </select>
          </div>
          <div>
            <label>Elevation (online)</label>
            <select id="elevMode">
              <option value="on">On (OpenTopo/online)</option>
              <option value="off">Off (offline)</option>
            </select>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Hole</legend>
        <div class="row">
          <div>
            <label>Hole #</label>
            <input id="holeNumber" type="number" min="1" max="36" value="1" />
          </div>
          <div>
            <label>Par</label>
            <input id="holePar" type="number" min="3" max="6" value="4" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Stroke</label>
            <input id="holeStroke" type="number" min="1" max="36" value="7" />
          </div>
          <div>
            <label>Start Center</label>
            <select id="startCenter">
              <option value="-25.746,28.229">Pretoria</option>
              <option value="-26.204,28.047">Johannesburg</option>
              <option value="-25.936,28.182">Blue Valley</option>
            </select>
          </div>
        </div>
        <div class="minor">Click the satellite map to drop the selected pin. Elevation only when online.</div>
      </fieldset>

      <fieldset>
        <legend>Pin Tools</legend>
        <div class="toolbar" id="tools"></div>
        <div class="hr"></div>
        <div class="chips" id="currentPins"></div>
        <div class="section-actions" style="margin-top:10px">
          <button class="btn secondary" id="undoBtn">Undo last pin</button>
          <button class="btn warn" id="clearHole">Clear hole pins</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Data</legend>
        <div class="section-actions">
          <button class="btn" id="exportBtn">Export hole JSON</button>
          <button class="btn secondary" id="exportCourseBtn">Export full course JSON</button>
          <input type="file" id="importFile" accept="application/json" />
        </div>
        <label style="margin-top:8px">Preview</label>
        <div class="json-box" id="preview"></div>
      </fieldset>

      <div class="minor">Pins: <b>TEE</b>, <b>FRONT</b>, <b>MID</b>, <b>BACK</b>, <b>TOILET</b>, <b>TAPS</b>, <b>STAKE WHITE/RED/YELLOW</b>. JSON matches gps.html.</div>
    </aside>

    <main>
      <div id="map"></div>
      <div class="legend minor">Satellite: Esri World Imagery • Streets: OpenStreetMap (both cacheable)</div>
    </main>
  </div>

  <script>
    // ---------------------------
    // Marker Icon Helpers
    // ---------------------------
    // Small dot (for FRONT/MID/BACK and STAKE_*). Slight outer stroke to stand out on satellite.
    function dotIcon(color = '#ffffff', size = 12, stroke = '#111', strokeWidth = 2) {
      const r = Math.floor(size / 2);
      const svg = encodeURIComponent(`<?xml version="1.0"?>
        <svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'>
          <circle cx='${r}' cy='${r}' r='${r - strokeWidth/2}' fill='${color}' stroke='${stroke}' stroke-width='${strokeWidth}' />
        </svg>`);
      return L.icon({
        iconUrl: `data:image/svg+xml;utf8,${svg}`,
        iconSize: [size, size],
        iconAnchor: [r, r]
      });
    }

    // Large icon-only (no pin body) for Toilet and Taps
    function largeSymbolIcon(svgPath, size = 40) {
      const svg = encodeURIComponent(`<?xml version="1.0"?>
        <svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 40 40'>
          <circle cx='20' cy='20' r='20' fill='rgba(17,24,39,0.15)' />
          ${svgPath}
        </svg>`);
      return L.icon({
        iconUrl: `data:image/svg+xml;utf8,${svg}`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
      });
    }

    const TOILET_SVG = `
      <rect x='8' y='8' width='24' height='24' rx='5' fill='#6b7280'/>
      <path d='M14 26h2l1-6 1 6h2l-2-10h-2l-2 10Zm8 0h2v-4h2v4h2V16h-2v4h-2v-4h-2v10Z' fill='white'/>
    `;
    const TAP_SVG = `
      <rect x='8' y='8' width='24' height='24' rx='5' fill='#0ea5e9'/>
      <path d='M10 18h10v-2h2v-2h8v2h-6v2h-4v4h4v2h-8v-2h2v-4h-8v-2h0Z' fill='white'/>
    `;

    // Icon set
    const ICONS = {
      // Tee (keep as a small green dot but larger than F/M/B for visibility)
      TEE: dotIcon('#16a34a', 14),

      // Front/Mid/Back small dots (Front white, Mid yellow, Back red)
      FRONT: dotIcon('#ffffff', 12),
      MID: dotIcon('#fbbf24', 12),
      BACK: dotIcon('#ef4444', 12),

      // Toilet / Taps: icon-only (no pin), larger
      TOILET: largeSymbolIcon(TOILET_SVG, 44),
      TAPS: largeSymbolIcon(TAP_SVG, 44),

      // Boundary stakes: tiny dots
      STAKE_WHITE: dotIcon('#ffffff', 10),
      STAKE_RED: dotIcon('#ef4444', 10),
      STAKE_YELLOW: dotIcon('#fbbf24', 10)
    };

    const TOOL_ORDER = ['TEE','FRONT','MID','BACK','TOILET','TAPS','STAKE_WHITE','STAKE_RED','STAKE_YELLOW'];

    // ---------------------------
    // App State
    // ---------------------------
    let map, activeTool = 'TEE', markers = [];
    const courseData = { meta: { name:"", id:"", pin:"", holes:18 }, holes:{} };

    // ---------------------------
    // UI: Tools
    // ---------------------------
    const toolsEl = document.getElementById('tools');
    TOOL_ORDER.forEach(key => {
      const btn = document.createElement('button');
      btn.className = 'tool';
      btn.dataset.tool = key;
      btn.innerHTML = `<img alt='' width='18' height='18' src='${ICONS[key].options.iconUrl}'/> <span>${key.replace('STAKE_','STAKE ')}</span>`;
      btn.addEventListener('click', () => setActiveTool(key));
      toolsEl.appendChild(btn);
    });
    function setActiveTool(tool){ activeTool = tool; [...toolsEl.children].forEach(b=>b.classList.toggle('active', b.dataset.tool===tool)); }
    setActiveTool('TEE');

    // ---------------------------
    // Map init (Satellite + Streets)
    // ---------------------------
    function initMap(){
      const def = document.getElementById('startCenter').value.split(',').map(Number);
      map = L.map('map', { zoomControl: true }).setView(def, 17);

      const esriWorldImagery = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 19, attribution: 'Imagery © Esri' }
      ).addTo(map);

      const osmStreets = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { maxZoom: 19, attribution: '&copy; OpenStreetMap' }
      );

      L.control.layers(
        { 'Satellite (Esri)': esriWorldImagery, 'Streets (OSM)': osmStreets },
        {},
        { position: 'topright', collapsed: true }
      ).addTo(map);

      map.on('click', handleMapClick);
    }
    initMap();

    async function handleMapClick(e){
      const pos = e.latlng;
      let elevation = null;
      if(document.getElementById('elevMode').value==='on'){
        try{
          const r = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${pos.lat},${pos.lng}`);
          const j = await r.json();
          elevation = Math.round(j?.results?.[0]?.elevation ?? null);
        }catch(_){ elevation = null; }
      }
      addPinToHole(activeTool, pos, elevation);
    }

    // ---------------------------
    // Data + Markers
    // ---------------------------
    function ensureHole(holeNo){
      if(!courseData.holes[holeNo]) courseData.holes[holeNo] = { par: 4, stroke: 1, pins: {} };
      return courseData.holes[holeNo];
    }

    function addPinToHole(kind, position, elev){
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      const par = parseInt(document.getElementById('holePar').value,10);
      const stroke = parseInt(document.getElementById('holeStroke').value,10);

      const hole = ensureHole(holeNo);
      hole.par = par; hole.stroke = stroke;

      const pinObj = { kind, lat: position.lat, lng: position.lng, elev_m: elev, ts: Date.now() };

      // Singular pins vs arrays
      const singular = ['TEE','FRONT','MID','BACK','TOILET'];
      if(singular.includes(kind)) {
        hole.pins[kind] = pinObj;
      } else {
        (hole.pins[kind] ||= []).push(pinObj);
      }

      // Render marker; store reference so dragging updates the exact object
      const marker = L.marker([position.lat, position.lng], { icon: ICONS[kind], draggable: true }).addTo(map);
      marker.__pinRef = { holeNo, kind, pinObj, index: singular.includes(kind) ? null : hole.pins[kind].length - 1 };
      marker.on('dragend', (ev) => {
        const ll = ev.target.getLatLng();
        const ref = ev.target.__pinRef;
        const h = courseData.holes[ref.holeNo];
        if (!h) return;
        if (Array.isArray(h.pins[ref.kind]) && ref.index != null) {
          h.pins[ref.kind][ref.index].lat = ll.lat;
          h.pins[ref.kind][ref.index].lng = ll.lng;
        } else if (h.pins[ref.kind]) {
          h.pins[ref.kind].lat = ll.lat;
          h.pins[ref.kind].lng = ll.lng;
        }
        refreshPreview();
      });

      markers.push(marker);
      refreshPinsUI(); refreshPreview();
    }

    function renderMarker(kind, p, holeNo, index=null){
      const marker = L.marker([p.lat, p.lng], { icon: ICONS[kind], draggable: true }).addTo(map);
      marker.__pinRef = { holeNo, kind, pinObj: p, index };
      marker.on('dragend', (ev) => {
        const ll = ev.target.getLatLng();
        const ref = ev.target.__pinRef;
        const h = courseData.holes[ref.holeNo];
        if (!h) return;
        if (Array.isArray(h.pins[ref.kind]) && ref.index != null) {
          h.pins[ref.kind][ref.index].lat = ll.lat;
          h.pins[ref.kind][ref.index].lng = ll.lng;
        } else if (h.pins[ref.kind]) {
          h.pins[ref.kind].lat = ll.lat;
          h.pins[ref.kind].lng = ll.lng;
        }
        refreshPreview();
      });
      markers.push(marker);
    }

    function redrawHoleMarkers(){
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      markers.forEach(m=>m.remove()); markers=[];
      const hole = courseData.holes[holeNo]; if(!hole) { refreshPinsUI(); return; }
      for (const [k, v] of Object.entries(hole.pins || {})) {
        if (Array.isArray(v)) v.forEach((p,i)=>renderMarker(k,p,holeNo,i));
        else if (v) renderMarker(k, v, holeNo, null);
      }
      refreshPinsUI();
    }

    // ---------------------------
    // UI: Pins summary + JSON preview
    // ---------------------------
    function refreshPinsUI(){
      const el = document.getElementById('currentPins'); el.innerHTML='';
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      const hole = courseData.holes[holeNo]; if(!hole) return;
      const pins = hole.pins || {};
      Object.entries(pins).forEach(([k,v])=>{
        const count = Array.isArray(v) ? v.length : (v?1:0);
        const chip = document.createElement('div'); chip.className='chip'; chip.textContent = `${k}: ${count}`; el.appendChild(chip);
      });
    }

    function refreshPreview(){
      courseData.meta.name = document.getElementById('courseName').value.trim();
      courseData.meta.id = document.getElementById('courseId').value.trim();
      courseData.meta.pin = document.getElementById('clubPin').value.trim();
      courseData.meta.holes = parseInt(document.getElementById('holesCount').value,10);
      const sorted = JSON.parse(JSON.stringify(courseData));
      sorted.holes = Object.fromEntries(Object.entries(sorted.holes).sort((a,b)=>a[0]-b[0]));
      document.getElementById('preview').textContent = JSON.stringify({ course: sorted.meta, holes: sorted.holes }, null, 2);
    }

    // ---------------------------
    // Buttons & Inputs
    // ---------------------------
    document.getElementById('undoBtn').addEventListener('click', ()=>{
      // remove last marker for current hole
      for(let i=markers.length-1;i>=0;i--){
        const m = markers[i];
        const holeNo = parseInt(document.getElementById('holeNumber').value,10);
        if(m.__pinRef?.holeNo === holeNo){
          const kind = m.__pinRef.kind;
          const ref = m.__pinRef;
          m.remove(); markers.splice(i,1);
          const pins = courseData.holes[holeNo]?.pins || {};
          if(Array.isArray(pins[kind])) pins[kind].pop(); else pins[kind] = undefined;
          refreshPinsUI(); refreshPreview(); break;
        }
      }
    });

    document.getElementById('clearHole').addEventListener('click', ()=>{
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      markers = markers.filter(m=>{ if(m.__pinRef?.holeNo===holeNo){ m.remove(); return false; } return true; });
      if(courseData.holes[holeNo]) courseData.holes[holeNo].pins = {};
      refreshPinsUI(); refreshPreview();
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const holeNo = parseInt(document.getElementById('holeNumber').value,10);
      const hole = courseData.holes[holeNo] || { par:null, stroke:null, pins:{} };
      const payload = { course: courseData.meta, hole: { number: holeNo, ...hole } };
      downloadJSON(payload, `${courseData.meta.id || 'COURSE'}-H${holeNo}.json`);
    });

    document.getElementById('exportCourseBtn').addEventListener('click', ()=>{
      const payload = { course: courseData.meta, holes: courseData.holes };
      downloadJSON(payload, `${courseData.meta.id || 'COURSE'}-course.json`);
    });

    document.getElementById('importFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return; const txt = await file.text();
      try{
        const json = JSON.parse(txt);
        if(json.course && json.holes){ courseData.meta = json.course; courseData.holes = json.holes; }
        else if(json.course && json.hole){ courseData.meta = json.course; courseData.holes[json.hole.number] = { par: json.hole.par, stroke: json.hole.stroke, pins: json.hole.pins }; }
        else { alert('Unrecognized JSON'); return; }
        document.getElementById('courseName').value = courseData.meta.name || '';
        document.getElementById('courseId').value = courseData.meta.id || '';
        document.getElementById('clubPin').value = courseData.meta.pin || '';
        document.getElementById('holesCount').value = String(courseData.meta.holes || 18);
        markers.forEach(m=>m.remove()); markers=[]; refreshPinsUI(); refreshPreview(); alert('Import OK. Switch holes to view/edit.');
      }catch(err){ console.error(err); alert('Invalid JSON'); }
    });

    ['courseName','courseId','clubPin','holesCount','holeNumber','holePar','holeStroke','startCenter'].forEach(id=>{
      document.getElementById(id).addEventListener('input', ()=>{ refreshPreview(); redrawHoleMarkers(); });
    });

    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
