<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrackLinq — Enter PIN</title>
  <style>
    :root{ --brand:#14532d; --brand-2:#166534; }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; min-height:100vh; display:grid; place-items:center; background:#f7f8f9; }
    .card{ background:#fff; padding:22px; border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.08); width:min(480px, 92vw); }
    h1{ margin:0 0 12px; font-size:22px; color:#111827; }
    p{ color:#6b7280; margin:0 0 16px; }
    label{ font-weight:600; display:block; margin:10px 0 6px; }
    input{ width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; }
    button{ padding:12px 14px; border:0; border-radius:10px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer; }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
    .muted{ font-size:13px; color:#6b7280; margin-top:10px; }
    .err{ color:#b91c1c; margin-top:10px; font-weight:600; }
    .ok{ color:#065f46; margin-top:10px; font-weight:600; }
    .divider{ margin:16px 0; border:none; border-top:1px solid #e5e7eb; }
    .ghost{ width:100%; background:#111827; }
    .links{ margin-top:10px; font-size:13px; color:#6b7280; }
    .links a{ color:#14532d; text-decoration:none; }
  </style>

<link rel="manifest" href="/manifest.webmanifest">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">
<meta name="theme-color" content="#14532d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">



  
</head>
<body>
  <div class="card">
    <h1>TrackLinq</h1>
    <p>Enter a club PIN or continue as a guest.</p>

    <label for="pin">Club PIN</label>
    <div class="row">
      <input id="pin" placeholder="e.g. SLK1234567" />
      <button id="pinBtn" type="button">Continue</button>
    </div>

    <hr class="divider" />
    <button id="guestBtn" type="button" class="ghost">Continue as Guest</button>

  </div>

  <script>
    // Try /courses first, then /course (to match your gps.html helper)
    async function fetchIndexJson() {
      const paths = ['/courses/index.json', '/course/index.json'];
      for (const p of paths) {
        try {
          const r = await fetch(p, { cache: 'no-store' });
          if (r.ok) return await r.json();
        } catch {}
      }
      throw new Error('index.json not found in /courses or /course');
    }

    function showMsg(t, cls = 'muted') {
      const el = document.getElementById('msg');
      el.className = cls;
      el.textContent = t;
    }

    function goGuest() {
      localStorage.setItem('tl_mode', 'guest');
      localStorage.removeItem('tl_club');
      localStorage.removeItem('tl_course_id');
      window.location.assign(`/gps.html?t=${Date.now()}`);
    }

    async function resolvePinLocal() {
      const pin = document.getElementById('pin').value.trim();
      if (!pin) return showMsg('Please enter a PIN', 'err');

      showMsg('Checking PIN…');
      let data;
      try {
        data = await fetchIndexJson(); // expects { courses: [...] }
      } catch (e) {
        return showMsg('Could not load course index.json', 'err');
      }

      const list = Array.isArray(data?.courses) ? data.courses : [];
      const found = list.find(c =>
        String(c.pin || '').toUpperCase() === pin.toUpperCase() &&
        (c.active !== false)
      );

      if (!found) return showMsg('PIN not found or inactive', 'err');

      // Persist session as CLUB and redirect to that course
      localStorage.setItem('tl_mode', 'club');
      localStorage.setItem('tl_club', JSON.stringify({
        id: found.id,
        name: found.name || found.id,
        short_code: found.short_code || ''
      }));
      localStorage.setItem('tl_course_id', found.id);

      showMsg(`Club: ${found.name || found.id} (${found.short_code || ''})`, 'ok');
      const url = `/gps.html?course=${encodeURIComponent(found.id)}&t=${Date.now()}`;
      window.location.assign(url);
    }

    document.getElementById('pinBtn').onclick = resolvePinLocal;
    document.getElementById('guestBtn').onclick = goGuest;

    // Convenience: press Enter in PIN field
    document.getElementById('pin').addEventListener('keydown', e => {
      if (e.key === 'Enter') resolvePinLocal();
    });
  </script>



<script>
if ('serviceWorker' in navigator) {
  (async () => {
    try {
      // Register the service worker at the site root so it covers /, /gps.html, /courses/*, etc.
      const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });

      // If a new worker finishes installing while the page is open, refresh to activate it
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        if (!sw) return;
        sw.addEventListener('statechange', () => {
          if (sw.state === 'installed' && navigator.serviceWorker.controller) {
            // optional: show a toast instead of reloading immediately
            location.reload();
          }
        });
      });

      // When the active controller changes (new SW took over), reload once
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        location.reload();
      });
    } catch (err) {
      console.log('SW register failed:', err);
    }
  })();
}
</script>

  

  
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js', { scope: '/' })
      .catch(console.error);
  });
}
</script>


  
</body>
</html>
