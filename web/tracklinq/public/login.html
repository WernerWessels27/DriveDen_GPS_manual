<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrackLinq — Enter PIN</title>
  <style>
    :root{ --brand:#14532d; --brand-2:#166534; }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; min-height:100vh; display:grid; place-items:center; background:#f7f8f9; }
    .card{ background:#fff; padding:22px; border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.08); width:min(480px, 92vw); }
    h1{ margin:0 0 12px; font-size:22px; color:#111827; }
    p{ color:#6b7280; margin:0 0 16px; }
    label{ font-weight:600; display:block; margin:10px 0 6px; }
    input{ width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; }
    button{ padding:12px 14px; border:0; border-radius:10px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer; }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
    .muted{ font-size:13px; color:#6b7280; margin-top:10px; }
    .err{ color:#b91c1c; margin-top:10px; font-weight:600; }
    .ok{ color:#065f46; margin-top:10px; font-weight:600; }
    .divider{ margin:16px 0; border:none; border-top:1px solid #e5e7eb; }
    .ghost{ width:100%; background:#111827; }
    .links{ margin-top:10px; font-size:13px; color:#6b7280; }
    .links a{ color:#14532d; text-decoration:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>TrackLinq</h1>
    <p>Enter a club PIN or device code, or continue as a guest.</p>

    <label for="pin">Club PIN</label>
    <div class="row">
      <input id="pin" placeholder="e.g. SLK1234567" />
      <button id="pinBtn" type="button">Continue</button>
    </div>

    <label for="dev" style="margin-top:14px;">Device code (club tablet)</label>
    <div class="row">
      <input id="dev" placeholder="e.g. SLK-7F4K-J2" />
      <button id="devBtn" type="button">Resolve</button>
    </div>

    <hr class="divider" />
    <button id="guestBtn" type="button" class="ghost">Continue as Guest</button>

    <div id="msg" class="muted">Tip: test with <b>SLK1234567</b> or <b>SLK-7F4K-J2</b>.</div>

    <div class="links">
      <a href="/health">Health</a>
    </div>
  </div>

  <script>
    // Map club short_code -> course file id (filename without .json)
    // Add more short codes as you onboard clubs, e.g. WERHA: 'werha'
    const COURSE_BY_SHORTCODE = { SLK: 'silverlakes' };

    function msg(t, cls='muted'){ const el=document.getElementById('msg'); el.className=cls; el.textContent=t; }

    function goToGPSForClub(club){
      const sc = String(club.short_code||'').toUpperCase();
      const courseId = COURSE_BY_SHORTCODE[sc];
      if(!courseId){ msg(`No course mapping for ${sc}.`, 'err'); return; }
      localStorage.setItem('tl_mode','club');
      localStorage.setItem('tl_club', JSON.stringify(club));
      const url = `/gps.html?course=${encodeURIComponent(courseId)}&t=${Date.now()}`; // cache-bust
      window.location.assign(url);
    }

    async function resolvePin(){
      const pin = document.getElementById('pin').value.trim();
      if(!pin) return msg('Please enter a PIN','err');
      msg('Checking PIN…');
      try{
        const r = await fetch(`/api/pin/resolve?pin=${encodeURIComponent(pin)}`, { cache:'no-store' });
        const j = await r.json();
        if(!j.ok) return msg('PIN not found or inactive','err');
        msg(`Club: ${j.club.name} (${j.club.short_code})`, 'ok');
        goToGPSForClub(j.club);
      }catch{ msg('Network error','err'); }
    }

    async function resolveDevice(){
      const code = document.getElementById('dev').value.trim();
      if(!code) return msg('Please enter a device code','err');
      msg('Checking device…');
      try{
        const r = await fetch(`/api/device/resolve?code=${encodeURIComponent(code)}`, { cache:'no-store' });
        const j = await r.json();
        if(!j.ok) return msg(j.error === 'device_inactive' ? 'Device inactive' : 'Device not found', 'err');
        msg(`Device OK for ${j.device.club_name} (${j.device.short_code})`, 'ok');
        goToGPSForClub({ id:j.device.club_id, name:j.device.club_name, short_code:j.device.short_code });
      }catch{ msg('Network error','err'); }
    }

    function continueAsGuest(){
      localStorage.setItem('tl_mode','guest');
      localStorage.removeItem('tl_club');
      window.location.assign(`/gps.html?t=${Date.now()}`); // No course param → guest can pick
    }

    document.getElementById('pinBtn').onclick = resolvePin;
    document.getElementById('devBtn').onclick = resolveDevice;
    document.getElementById('guestBtn').onclick = continueAsGuest;
  </script>
</body>
</html>
