<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrackLinq — Enter PIN</title>
  <style>
    :root{ --brand:#14532d; }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; min-height:100vh; display:grid; place-items:center; background:#f7f8f9; }
    .card{ background:#fff; padding:22px; border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.08); width:min(460px, 92vw); }
    h1{ margin:0 0 12px; font-size:22px; color:#111827; }
    p{ color:#6b7280; margin:0 0 16px; }
    label{ font-weight:600; display:block; margin:10px 0 6px; }
    input{ width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; }
    button{ width:100%; margin-top:14px; padding:12px 14px; border:0; border-radius:10px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer; }
    .muted{ font-size:13px; color:#6b7280; margin-top:10px; }
    .err{ color:#b91c1c; margin-top:10px; font-weight:600; }
    .ok{ color:#065f46; margin-top:10px; font-weight:600; }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
  </style>
</head>
<body>
  <div class="card">
    <h1>TrackLinq</h1>
    <p>Enter club PIN (10 digits) or a device code.</p>

    <label for="pin">Club PIN</label>
    <div class="row">
      <input id="pin" placeholder="e.g. SLK1234567" />
      <button id="pinBtn">Continue</button>
    </div>

    <label for="dev" style="margin-top:14px;">Device code</label>
    <div class="row">
      <input id="dev" placeholder="e.g. SLK-7F4K-J2" />
      <button id="devBtn">Resolve</button>
    </div>

    <div id="msg" class="muted">Tip: use <b>SLK1234567</b> or <b>SLK-7F4K-J2</b> to test.</div>
  </div>

  <script>
    const msg = (t, cls='muted') => { const el=document.getElementById('msg'); el.className=cls; el.textContent=t; };

    async function resolvePin() {
      const pin = document.getElementById('pin').value.trim();
      if(!pin) return msg('Please enter a PIN','err');
      msg('Checking PIN…');
      try{
        const r = await fetch(`/api/pin/resolve?pin=${encodeURIComponent(pin)}`);
        const j = await r.json();
        if(!j.ok) return msg('PIN not found or inactive','err');

        // Save chosen club for the GPS app to consume later
        localStorage.setItem('tl_club', JSON.stringify(j.club));
        msg(`Club: ${j.club.name} (${j.club.short_code})`, 'ok');

        // TODO: when GPS UI is copied into this service, redirect to it:
        // location.href = '/index.html?course=silverlakes';
      }catch(e){ msg('Network error','err'); }
    }

    async function resolveDevice(){
      const code = document.getElementById('dev').value.trim();
      if(!code) return msg('Please enter a device code','err');
      msg('Checking device…');
      try{
        const r = await fetch(`/api/device/resolve?code=${encodeURIComponent(code)}`);
        const j = await r.json();
        if(!j.ok) return msg(j.error === 'device_inactive' ? 'Device inactive' : 'Device not found', 'err');

        localStorage.setItem('tl_device', JSON.stringify(j.device));
        msg(`Device OK for ${j.device.club_name} (${j.device.short_code})`, 'ok');

        // TODO: redirect to GPS with course once front-end moved:
        // location.href = '/index.html?course=silverlakes';
      }catch(e){ msg('Network error','err'); }
    }

    document.getElementById('pinBtn').onclick = resolvePin;
    document.getElementById('devBtn').onclick = resolveDevice;
  </script>
</body>
</html>
