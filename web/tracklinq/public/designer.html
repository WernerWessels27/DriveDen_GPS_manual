<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Designer • Vector Course Builder (Freehand + Basemap)</title>
  <style>
    :root{
      --bg:#e8f5e9; /* neutral green background */
      --panel:#ffffff; --line:#1f2937; --accent:#0ea5e9; --muted:#6b7280;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .layout{display:grid;grid-template-columns:360px 1fr;grid-template-rows:auto 1fr; height:100%}
    header{grid-column:1/3;display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#fff}
    header h1{font-size:18px;margin:0;font-weight:700}
    header .spacer{flex:1}
    #left{border-right:1px solid #e5e7eb;overflow:auto;background:#fafafa}
    .section{padding:12px;border-bottom:1px solid #eee}
    .group{margin-bottom:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{display:block;font-size:12px;color:#374151;margin:6px 0 2px}
    input[type=text],input[type=number]{width:100%;box-sizing:border-box;padding:8px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    select{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.warn{background:#fff7ed;color:#9a3412;border-color:#fdba74}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px}
    .toolbtn{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
    .toolbtn.active{outline:2px solid #0ea5e9}
    .legend{font-size:12px;color:#6b7280}
    #stageWrap{position:relative;background:var(--bg)}
    #gmaps{position:absolute;inset:0;z-index:0;display:none}
    canvas{position:absolute;inset:0;z-index:1;display:block;background:transparent}
    .top-right{position:absolute;top:10px;right:10px;display:flex;gap:6px;z-index:5}
    .toast{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:#111827;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;opacity:.92;z-index:6}
    #coords{position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,.9);border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;font-size:12px;z-index:6}
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>Vector Course Designer</h1>
      <span class="legend">Freehand + Basemap • v1.1</span>
      <div class="spacer"></div>
      <button class="btn" id="btn-import">Import JSON</button>
      <button class="btn primary" id="btn-export-json">Export JSON</button>
      <button class="btn" id="btn-export-png">Export PNG + world.json</button>
    </header>

    <aside id="left">
      <div class="section">
        <div class="row">
          <div>
            <label>Club Name</label>
            <input id="clubName" type="text" placeholder="e.g. Silver Lakes"/>
          </div>
          <div>
            <label>Club ID</label>
            <input id="clubId" type="text" placeholder="SLK"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Club PIN (10)</label>
            <input id="clubPin" maxlength="10" type="text" placeholder="SLK1234567"/>
          </div>
          <div>
            <label>Status</label>
            <select id="clubActive"><option value="true">Active</option><option value="false">Not Active</option></select>
          </div>
        </div>
      </div>

      <div class="section">
        <label>Bounds (South, West, North, East)</label>
        <div class="row">
          <input id="bSouth" type="number" step="0.000001" placeholder="south"/>
          <input id="bWest" type="number" step="0.000001" placeholder="west"/>
        </div>
        <div class="row">
          <input id="bNorth" type="number" step="0.000001" placeholder="north"/>
          <input id="bEast" type="number" step="0.000001" placeholder="east"/>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <button class="btn" id="btn-apply-bounds">Apply</button>
          <button class="btn" id="btn-fit-to-data">Fit to Data</button>
        </div>
        <p class="legend">Tip: Set bounds to your hole rectangle. We use these to convert lat/lng ↔︎ pixels.</p>
      </div>

      <div class="section">
        <div class="group">
          <label>Google Maps basemap (optional)</label>
          <input id="gmKey" type="text" placeholder="Google Maps API key"/>
          <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
            <button class="btn" id="btn-enable-basemap">Enable</button>
            <button class="btn" id="btn-disable-basemap">Disable</button>
            <button class="btn" id="btn-basemap-opacity">Opacity 60%</button>
          </div>
          <p class="legend">For tracing only. We don’t export Google tiles.</p>
        </div>
        <div class="group">
          <label>Reference image (offline tracing)</label>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn" id="btn-load-ref">Load PNG/JPG</button>
            <button class="btn" id="btn-clear-ref">Clear</button>
            <button class="btn" id="btn-ref-opacity">Ref Opacity 50%</button>
          </div>
        </div>
      </div>

      <div class="section">
        <label>Tools</label>
        <div class="legend" style="margin-bottom:6px">Freehand draw for areas is ON by default. Hold mouse/pen and trace; release to finish.</div>
        <div class="group">
          <div class="legend">Pins</div>
          <div class="toolbar" id="toolsPins"></div>
        </div>
        <div class="group">
          <div class="legend">Areas</div>
          <div class="toolbar" id="toolsAreas"></div>
        </div>
        <div class="group">
          <div class="legend">POIs</div>
          <div class="toolbar" id="toolsPois"></div>
        </div>
      </div>

      <div class="section">
        <label>Style</label>
        <div class="row">
          <div>
            <label>Fill</label>
            <input id="fill" type="text" value="#6fbf73"/>
          </div>
          <div>
            <label>Stroke</label>
            <input id="stroke" type="text" value="#245a2c"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Stroke px</label>
            <input id="strokeW" type="number" value="2"/>
          </div>
          <div>
            <label>Fairway stripes</label>
            <select id="stripe"><option value="no">No</option><option value="yes">Yes</option></select>
          </div>
        </div>
      </div>

      <div class="section">
        <label>Hole meta</label>
        <div class="row">
          <div>
            <label>Hole #</label>
            <input id="holeNum" type="number" min="1" max="18" value="1"/>
          </div>
          <div>
            <label>Par</label>
            <input id="holePar" type="number" min="3" max="6" value="4"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Stroke</label>
            <input id="holeStroke" type="number" min="1" max="18" value="7"/>
          </div>
          <div style="display:flex;align-items:end;gap:6px">
            <button class="btn" id="btn-apply-hole">Apply</button>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Tee elev (m)</label>
            <input id="elevTee" type="number" step="0.1"/>
          </div>
          <div>
            <label>Front elev (m)</label>
            <input id="elevFront" type="number" step="0.1"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Mid elev (m)</label>
            <input id="elevMid" type="number" step="0.1"/>
          </div>
          <div>
            <label>Back elev (m)</label>
            <input id="elevBack" type="number" step="0.1"/>
          </div>
        </div>
      </div>

      <div class="section">
        <label>Shortcuts</label>
        <p class="legend">*Pins:* click once. *Areas:* press, drag to trace, release to finish. <b>Del</b> delete selection, <b>Z/Y</b> undo/redo.</p>
      </div>
    </aside>

    <main id="stageWrap">
      <div class="top-right">
        <button class="btn" id="btn-zoom-out">-</button>
        <button class="btn" id="btn-zoom-in">+</button>
        <button class="btn" id="btn-fit-bbox">Fit CART↔BACK</button>
      </div>
      <div id="toast" class="toast" style="display:none"></div>
      <div id="coords">lat: —, lng: —</div>
      <div id="gmaps"></div>
      <canvas id="cv"></canvas>
    </main>
  </div>

  <script>
    // =================== State & Projection ===================
    const state = {
      meta:{name:"",id:"",pin:"",active:true},
      bounds:{south:-25.705, west:28.195, north:-25.695, east:28.205},
      zoom:1, panX:0, panY:0,
      canvas:null, ctx:null, refImage:null, refOpacity:0.4,
      gmaps:null, gmapsOpacity:0.6, gmapsKey:"",
      holes: Array.from({length:18}, (_,i)=>({number:i+1, par:4, stroke:i+1, pins:{tee:null, front:null, mid:null, back:null}})),
      features:{polygons:[], polylines:[], points:[]},
      tool:"fairway", drawing:[], drawingType:null, selected=null,
      undo:[], redo:[]
    };

    const Tools = {
      pins:[
        {id:"teePin", label:"Tee Pin", kind:"point", role:"tee", color:"#0ea5e9"},
        {id:"frontPin", label:"Front Pin", kind:"point", role:"front", color:"#22c55e"},
        {id:"midPin", label:"Mid Pin", kind:"point", role:"mid", color:"#10b981"},
        {id:"backPin", label:"Back Pin", kind:"point", role:"back", color:"#059669"}
      ],
      areas:[
        {id:"teeArea", label:"Tee Area", kind:"polygon", style:{fill:"#8dd39b", stroke:"#2f6b3b", width:2}},
        {id:"fairway", label:"Fairway", kind:"polygon", style:{fill:"#6fbf73", stroke:"#245a2c", width:2, stripe:true}},
        {id:"green", label:"Green", kind:"polygon", style:{fill:"#66a85e", stroke:"#1f7a3d", width:2}},
        {id:"bunker", label:"Bunker", kind:"polygon", style:{fill:"#e8d7a6", stroke:"#b59b60", width:2}},
        {id:"rough", label:"Rough", kind:"polygon", style:{fill:"#93c590", stroke:"#4d7c4a", width:2}},
        {id:"water", label:"Water", kind:"polygon", style:{fill:"#6aa9e9", stroke:"#306aa8", width:2}},
        {id:"rocks", label:"Rocks", kind:"polygon", style:{fill:"#b0b4b8", stroke:"#6b7280", width:2}}
      ],
      pois:[
        {id:"toilet", label:"Toilet", kind:"point", color:"#8b5cf6"},
        {id:"tree", label:"Tree", kind:"point", color:"#14532d"},
        {id:"bush", label:"Bush", kind:"point", color:"#3f6212"}
      ]
    };

    const el=id=>document.getElementById(id);
    const cv=state.canvas=el('cv');
    const ctx=state.ctx=cv.getContext('2d');

    function lngToX(lng){const {west,east}=state.bounds;return (lng-west)/(east-west)*cv.width}
    function latToY(lat){const {south,north}=state.bounds;return (north-lat)/(north-south)*cv.height}
    function xToLng(x){const {west,east}=state.bounds;return west + (x/cv.width)*(east-west)}
    function yToLat(y){const {south,north}=state.bounds;return north - (y/cv.height)*(north-south)}

    function worldToScreen([lat,lng]){let x=lngToX(lng), y=latToY(lat); x= (x+state.panX)*state.zoom; y=(y+state.panY)*state.zoom; return [x,y]}
    function screenToWorld(x,y){x/=state.zoom; y/=state.zoom; x-=state.panX; y-=state.panY; return [yToLat(y), xToLng(x)]}

    // ============== UI build ==============
    function buildToolbars(){
      const mk=(arr, host)=>{
        host.innerHTML='';
        arr.forEach(t=>{
          const b=document.createElement('button'); b.className='toolbtn'; b.textContent=t.label; b.onclick=()=>{state.tool=t.id; highlightTools(); toast(t.label)}; host.appendChild(b);
        })
      }
      mk(Tools.pins, el('toolsPins'));
      mk(Tools.areas, el('toolsAreas'));
      mk(Tools.pois, el('toolsPois'));
      highlightTools();
    }
    function highlightTools(){
      document.querySelectorAll('.toolbtn').forEach(btn=> btn.classList.remove('active'));
      const all=[...Tools.pins,...Tools.areas,...Tools.pois];
      const t=all.find(x=>x.id===state.tool); if(!t) return;
      [...document.querySelectorAll('.toolbtn')].find(b=>b.textContent===t.label)?.classList.add('active');
    }

    // Bounds inputs
    ['bSouth','bWest','bNorth','bEast'].forEach(id=> el(id).value = state.bounds[id.slice(1).toLowerCase()]);
    el('btn-apply-bounds').onclick=()=>{state.bounds.south=parseFloat(el('bSouth').value);state.bounds.west=parseFloat(el('bWest').value);state.bounds.north=parseFloat(el('bNorth').value);state.bounds.east=parseFloat(el('bEast').value);render(); positionGMaps();};

    // Basemap controls
    el('btn-enable-basemap').onclick=()=>{ state.gmapsKey = el('gmKey').value.trim(); if(!state.gmapsKey) {alert('Enter API key'); return;} loadGoogleMaps(); };
    el('btn-disable-basemap').onclick=()=>{ el('gmaps').style.display='none'; state.gmaps=null; };
    el('btn-basemap-opacity').onclick=()=>{ state.gmapsOpacity = state.gmapsOpacity===0.6?0.85:0.6; if(state.gmaps) el('gmaps').style.opacity=state.gmapsOpacity; };

    // Ref image
    el('btn-load-ref').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.onchange=()=>{const f=inp.files?.[0]; if(!f) return; const img=new Image(); img.onload=()=>{state.refImage=img; render();}; img.src=URL.createObjectURL(f)}; inp.click(); };
    el('btn-clear-ref').onclick=()=>{state.refImage=null; render();}
    el('btn-ref-opacity').onclick=()=>{state.refOpacity = state.refOpacity===0.4?0.7:0.4; render();}

    // Zoom
    el('btn-zoom-in').onclick=()=>{state.zoom*=1.2; render();};
    el('btn-zoom-out').onclick=()=>{state.zoom/=1.2; render();};

    // Fit
    el('btn-fit-bbox').onclick=()=>{ const h = state.holes[(+el('holeNum').value||1)-1]; const a=h?.pins?.tee, b=h?.pins?.back; if(!a||!b) return toast('Set Tee and Back first'); fitTwoPoints(a,b); };
    function fitTwoPoints(A,B){ const [ax,ay]=[lngToX(A.lng), latToY(A.lat)]; const [bx,by]=[lngToX(B.lng), latToY(B.lat)]; const pad=80; const w=cv.width-2*pad, h=cv.height-2*pad; const dx=Math.abs(ax-bx), dy=Math.abs(ay-by); const zx=w/dx, zy=h/dy; const z=Math.max(1, Math.min(zx,zy)); state.zoom = z; const cx=(ax+bx)/2, cy=(ay+by)/2; state.panX = (cv.width/2)/z - cx; state.panY = (cv.height/2)/z - cy; render(); }

    // Meta + hole meta
    ['clubName','clubId','clubPin','clubActive'].forEach(id=> el(id).addEventListener('change',()=>{ state.meta.name=el('clubName').value.trim(); state.meta.id=el('clubId').value.trim(); state.meta.pin=el('clubPin').value.trim().toUpperCase(); state.meta.active=(el('clubActive').value==='true'); }));
    el('btn-apply-hole').onclick=()=>{ const idx=(+el('holeNum').value)-1; const h=state.holes[idx]; if(!h) return; h.par=+el('holePar').value||h.par; h.stroke=+el('holeStroke').value||h.stroke; if(h.pins.tee) h.pins.tee.elev_m = numOrNull(el('elevTee').value); if(h.pins.front) h.pins.front.elev_m = numOrNull(el('elevFront').value); if(h.pins.mid) h.pins.mid.elev_m = numOrNull(el('elevMid').value); if(h.pins.back) h.pins.back.elev_m = numOrNull(el('elevBack').value); toast('Hole updated'); render(); }
    function numOrNull(v){const n=parseFloat(v); return Number.isFinite(n)?n:null}

    // Import / Export
    el('btn-export-json').onclick=()=>{ const data = exportJSON(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${(state.meta.id||'course')}.vector.json`; a.click(); URL.revokeObjectURL(a.href); };
    el('btn-export-png').onclick=()=>{ const png=cv.toDataURL('image/png'); const a=document.createElement('a'); a.href=png; a.download=`${(state.meta.id||'course')}.png`; a.click(); const world={bounds:state.bounds, width:cv.width, height:cv.height}; const blob=new Blob([JSON.stringify(world,null,2)],{type:'application/json'}); const a2=document.createElement('a'); a2.href=URL.createObjectURL(blob); a2.download=`${(state.meta.id||'course')}.world.json`; a2.click(); URL.revokeObjectURL(a2.href); };
    el('btn-import').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json,.json'; inp.onchange=async()=>{const f=inp.files?.[0]; if(!f) return; const txt=await f.text(); try{const obj=JSON.parse(txt); importJSON(obj); toast('Imported');}catch(e){alert('Invalid JSON')};}; inp.click(); };

    function exportJSON(){ return { meta: state.meta, bounds: state.bounds, holes: state.holes, features: state.features }; }
    function importJSON(obj){ state.meta=obj.meta||state.meta; state.bounds=obj.bounds||state.bounds; state.holes=obj.holes||state.holes; state.features=obj.features||state.features; ['bSouth','bWest','bNorth','bEast'].forEach(id=> el(id).value = state.bounds[id.slice(1).toLowerCase()]); render(); positionGMaps(); }

    // ============== Freehand drawing / points ==============
    cv.addEventListener('mousedown', onDown); cv.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
    window.addEventListener('keydown', e=>{ if((e.key==='z'||e.key==='Z')&&(e.ctrlKey||e.metaKey)) undo(); if((e.key==='y'||e.key==='Y')&&(e.ctrlKey||e.metaKey)) redo(); if(e.key==='Delete'&&state.selected){ const {kind,index}=state.selected; if(kind==='poly') state.features.polygons.splice(index,1); if(kind==='pt') state.features.points.splice(index,1); state.selected=null; snapshot(); render(); } });

    function currentAreaTool(){ return Tools.areas.find(t=>t.id===state.tool) }
    function currentPinTool(){ return Tools.pins.find(t=>t.id===state.tool) || Tools.pois.find(t=>t.id===state.tool) }

    let isDrawing=false; let lastAdd=0;
    function onDown(e){ const pin=currentPinTool(); const area=currentAreaTool(); const [lat,lng]=screenToWorld(e.offsetX,e.offsetY); if(pin){ dropPoint(pin, lat,lng); return; } if(area){ state.drawing=[{lat,lng}]; isDrawing=true; lastAdd=performance.now(); render(); } }
    function onMove(e){ const [lat,lng]=screenToWorld(e.offsetX,e.offsetY); el('coords').textContent=`lat: ${lat.toFixed(6)}, lng: ${lng.toFixed(6)}`; if(!isDrawing) return; const now=performance.now(); if(now-lastAdd>25){ state.drawing.push({lat,lng}); lastAdd=now; render(); } }
    function onUp(e){ if(!isDrawing) return; const area=currentAreaTool(); if(!area) return; // finish polygon
      const coords=[...state.drawing]; state.drawing=[]; isDrawing=false; state.features.polygons.push({type:area.id, hole:+el('holeNum').value, style:currentStyle(area), coords}); snapshot(); render(); }

    function dropPoint(tool, lat,lng){
      // visible point
      state.features.points.push({type: tool.role? tool.role : tool.id, coords:{lat,lng}});
      // If pin role, sync to hole pins and try elevation
      if(tool.role){ const h=state.holes[(+el('holeNum').value)-1]; h.pins[tool.role]={lat,lng}; fetchElevationIfPossible(tool.role, lat, lng); syncPinsUI(h); }
      snapshot(); render();
    }

    function syncPinsUI(h){ el('elevTee').value = vOrBlank(h.pins.tee?.elev_m); el('elevFront').value=vOrBlank(h.pins.front?.elev_m); el('elevMid').value=vOrBlank(h.pins.mid?.elev_m); el('elevBack').value=vOrBlank(h.pins.back?.elev_m); }
    function vOrBlank(v){ return (v===0 || (v && !Number.isNaN(v)))? v : '' }

    async function fetchElevationIfPossible(role, lat, lng){
      if(!state.gmapsKey) return; // use the same key; Elevation API must be enabled
      try{
        const url=`https://maps.googleapis.com/maps/api/elevation/json?locations=${lat},${lng}&key=${state.gmapsKey}`;
        const res=await fetch(url); const data=await res.json();
        const elev=data.results?.[0]?.elevation; if(Number.isFinite(elev)){ const idx=(+el('holeNum').value)-1; state.holes[idx].pins[role].elev_m=Math.round(elev*10)/10; syncPinsUI(state.holes[idx]); toast(`${role} elevation: ${Math.round(elev)} m`); }
      }catch(err){ /* ignore */ }
    }

    function currentStyle(tool){ const fill=el('fill').value|| (tool.style?.fill||'#6fbf73'); const stroke=el('stroke').value|| (tool.style?.stroke||'#245a2c'); const width=+el('strokeW').value || (tool.style?.width||2); const stripe=(el('stripe').value==='yes'); return {fill, stroke, width, stripe}; }

    function snapshot(){ state.undo.push(JSON.stringify(exportJSON())); state.redo.length=0; }
    function undo(){ if(state.undo.length<2) return; const cur=state.undo.pop(); state.redo.push(cur); importJSON(JSON.parse(state.undo[state.undo.length-1])); }
    function redo(){ if(!state.redo.length) return; const nxt=state.redo.pop(); state.undo.push(nxt); importJSON(JSON.parse(nxt)); }

    // ============== Rendering ==============
    window.addEventListener('resize', sizeCanvas);
    function sizeCanvas(){ cv.width = (document.body.clientWidth-360); cv.height = (document.body.clientHeight-50); render(); positionGMaps(); }

    function render(){ ctx.clearRect(0,0,cv.width,cv.height); // reference image
      if(state.refImage){ ctx.globalAlpha=state.refOpacity; ctx.drawImage(state.refImage, 0,0, cv.width, cv.height); ctx.globalAlpha=1; }
      // polygons
      state.features.polygons.forEach((p)=> drawPolygon(p));
      // points
      state.features.points.forEach((p)=> drawPoint(p));
      // drawing preview
      if(state.drawing.length){ drawPreview(); }
      // frame
      ctx.strokeStyle="#94a3b8"; ctx.lineWidth=1; ctx.strokeRect(0,0,cv.width,cv.height);
    }

    function drawPolygon(p){ const pts=p.coords.map(c=>worldToScreen([c.lat,c.lng])); if(pts.length<2) return; ctx.beginPath(); ctx.moveTo(pts[0][0], pts[0][1]); for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i][0], pts[i][1]); ctx.closePath(); ctx.fillStyle=p.style?.fill||'#6fbf73'; ctx.strokeStyle=p.style?.stroke||'#245a2c'; ctx.lineWidth=p.style?.width||2; ctx.fill(); ctx.stroke(); if(p.type==='fairway' && (p.style?.stripe)){ ctx.save(); ctx.clip(); const step=22; for(let i=-cv.height;i<cv.height*2;i+=step){ ctx.beginPath(); ctx.rect(-cv.width,i,cv.width*3, step/2); ctx.fillStyle=hexShift(p.style.fill||'#6fbf73', -10); ctx.fill(); } ctx.restore(); } }

    function hexShift(hex, delta){ try{ let c=parseInt(hex.replace('#',''),16); let r=(c>>16)&255,g=(c>>8)&255,b=c&255; const adj=v=>Math.max(0,Math.min(255,v+delta)); r=adj(r); g=adj(g); b=adj(b); return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);}catch(e){return hex}}

    function drawPoint(p){ const [x,y]=worldToScreen([p.coords.lat,p.coords.lng]); const color=pointColor(p.type); ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); ctx.strokeStyle="#1f2937"; ctx.lineWidth=1; ctx.stroke(); }
    function pointColor(type){ const all=[...Tools.pins,...Tools.pois]; const t=all.find(t=> (t.role||t.id)===type); return t?.color||'#111827'; }

    function drawPreview(){ const area=currentAreaTool(); if(!area) return; const scr=state.drawing.map(c=>worldToScreen([c.lat,c.lng])); ctx.beginPath(); ctx.moveTo(scr[0][0], scr[0][1]); for(let i=1;i<scr.length;i++) ctx.lineTo(scr[i][0], scr[i][1]); ctx.strokeStyle=(area.style?.stroke||'#245a2c'); ctx.lineWidth=(area.style?.width||2); ctx.stroke(); }

    function toast(t){ const d=el('toast'); d.textContent=t; d.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>d.style.display='none', 1200); }

    // ============== Google Maps basemap ==============
    function loadGoogleMaps(){ if(state.gmaps){ el('gmaps').style.display='block'; el('gmaps').style.opacity=state.gmapsOpacity; return; } const s=document.createElement('script'); s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(state.gmapsKey)}&libraries=maps`; s.onload=()=>{ const div=el('gmaps'); div.style.display='block'; div.style.opacity=state.gmapsOpacity; state.gmaps=new google.maps.Map(div,{center:{lat:(state.bounds.north+state.bounds.south)/2,lng:(state.bounds.east+state.bounds.west)/2}, zoom:16, mapTypeId:'satellite', disableDefaultUI:true}); positionGMaps(); }; document.head.appendChild(s); }
    function positionGMaps(){ if(!state.gmaps) return; const b=new google.maps.LatLngBounds( {lat:state.bounds.south, lng:state.bounds.west}, {lat:state.bounds.north, lng:state.bounds.east} ); state.gmaps.fitBounds(b); }

    // boot
    buildToolbars(); sizeCanvas(); snapshot(); render();
  </script>
</body>
</html>
