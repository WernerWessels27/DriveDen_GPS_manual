<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrackLinq GPS</title>
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --muted:#a9b0bf; --text:#e8ecf3; --accent:#42a5f5; --good:#6fdc8c; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1000px;margin:0 auto;padding:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand b{letter-spacing:.3px}
    .chip{font-size:12px;padding:4px 8px;border:1px solid #2a2f3a;border-radius:999px;background:#131622;color:var(--muted)}
    .row{display:flex;gap:10px}
    .grow{flex:1}
    .card{background:var(--card);border:1px solid #232837;border-radius:14px;padding:12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;border-radius:12px;border:1px dashed #2b3242}
    .kpi .big{font-size:28px;font-weight:700}
    .kpi .sub{font-size:12px;color:var(--muted)}
    button{background:#1c2230;border:1px solid #2b3242;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    button:active{transform:translateY(1px)}
    .btn-accent{background:var(--accent);border-color:#2b6bb3;color:#04121f}
    .btn-ghost{background:transparent}
    .toolbar{display:flex;gap:8px}
    .hide{display:none !important}
    .menuWrap{position:relative}
    .hamburger{position:relative;min-width:44px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;border:1px solid #2b3242;background:#1c2230}
    .hamburger:after{ /* selection bubble only when .open */
      content:""; position:absolute; inset:auto auto -6px 50%; width:10px; height:10px;
      transform:translateX(-50%); border-radius:50%; background:transparent; transition:.2s;
    }
    .menuWrap.open .hamburger:after{background:var(--accent)}
    .menu{position:absolute; top:48px; right:0; background:#0f1420; border:1px solid #2b3242; border-radius:12px; min-width:220px; padding:6px; z-index:10}
    .menu button{width:100%; text-align:left; background:transparent}
    .two{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .rowWrap{display:flex; gap:10px; flex-wrap:wrap}
    .btnWide{width:100%}
    .note{color:var(--muted);font-size:12px}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .two{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <button id="hamburger" class="hamburger" aria-label="Open menu">
          <!-- icon -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M3 6h18M3 12h18M3 18h18" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <b>TrackLinq GPS</b>
        <span id="roleChip" class="chip">Role: <span id="roleText">GUEST</span></span>
        <span id="courseChip" class="chip">Course: <span id="courseText">silverlakes</span></span>
      </div>
      <div class="toolbar">
        <button id="btnScorecard" class="btn-accent">Scorecard</button>
        <button id="btnHistory" class="">History</button>
        <button id="btnSwitchRole" class="btn-ghost">Switch Role</button>
      </div>
      <div class="menuWrap" id="menuWrap">
        <div id="menu" class="menu hide" role="menu" aria-label="Main menu">
          <div class="card" style="padding:6px">
            <div class="note" style="margin:8px 6px 6px">Quick actions</div>
            <button data-action="selectCourse">Select Course</button>
            <button data-action="selectClub">Select Club</button>
            <button data-action="logout">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="row" style="margin-top:12px">
      <div class="card grow">
        <div class="grid">
          <div class="kpi">
            <div class="sub">Front</div>
            <div id="frontDist" class="big">--</div>
            <div id="frontElev" class="sub">Δ --</div>
          </div>
          <div class="kpi">
            <div class="sub">Middle</div>
            <div id="midDist" class="big">--</div>
            <div id="midElev" class="sub">Δ --</div>
          </div>
          <div class="kpi">
            <div class="sub">Back</div>
            <div id="backDist" class="big">--</div>
            <div id="backElev" class="sub">Δ --</div>
          </div>
        </div>
        <div class="rowWrap" style="margin-top:10px">
          <button id="prevHole">◀ Hole</button>
          <div class="chip" id="holeChip">Hole 1 / 18</div>
          <button id="nextHole">Hole ▶</button>
          <span class="note">Tap the map to re-center target.</span>
        </div>
      </div>
    </div>

    <div class="two" style="margin-top:10px">
      <div class="card">
        <div class="note">Live</div>
        <div id="liveInfo">Waiting for GPS…</div>
      </div>
      <div class="card">
        <div class="note">Actions</div>
        <div class="rowWrap">
          <button id="btnCenter">Center to Player</button>
          <button id="btnSaveShot">Save Shot</button>
          <button id="btnEndHole">End Hole</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="note">Debug</div>
      <pre id="debug" style="white-space:pre-wrap; font-size:12px; color:#9fb2ff; margin:0"></pre>
    </div>
  </div>

  <script>
  /***********************
   * SIMPLE STATE
   ***********************/
  const state = {
    role: localStorage.getItem('tracklinq_role') || 'GUEST', // 'GUEST' | 'CLUB'
    course: localStorage.getItem('tracklinq_course') || 'silverlakes',
    holeIndex: 0,
    courseData: null,
    position: null,  // {lat, lng, elev?}
  };

  const els = {
    roleText: document.getElementById('roleText'),
    roleChip: document.getElementById('roleChip'),
    courseText: document.getElementById('courseText'),
    courseChip: document.getElementById('courseChip'),
    btnScorecard: document.getElementById('btnScorecard'),
    btnHistory: document.getElementById('btnHistory'),
    btnSwitchRole: document.getElementById('btnSwitchRole'),
    hamburger: document.getElementById('hamburger'),
    menu: document.getElementById('menu'),
    menuWrap: document.getElementById('menuWrap'),
    holeChip: document.getElementById('holeChip'),
    frontDist: document.getElementById('frontDist'),
    midDist: document.getElementById('midDist'),
    backDist: document.getElementById('backDist'),
    frontElev: document.getElementById('frontElev'),
    midElev: document.getElementById('midElev'),
    backElev: document.getElementById('backElev'),
    prevHole: document.getElementById('prevHole'),
    nextHole: document.getElementById('nextHole'),
    liveInfo: document.getElementById('liveInfo'),
    center: document.getElementById('btnCenter'),
    saveShot: document.getElementById('btnSaveShot'),
    endHole: document.getElementById('btnEndHole'),
    debug: document.getElementById('debug'),
  };

  /***********************
   * UTILITIES
   ***********************/
  const metersToDisplay = (m) => `${Math.round(m)} m`;
  const elevToDisplay = (m) => {
    if (m == null || Number.isNaN(m)) return 'Δ --';
    const sign = m > 0 ? '+' : (m < 0 ? '−' : '±');
    return `Δ ${sign}${Math.abs(Math.round(m))} m`;
  };

  // Haversine for distance
  function distanceMeters(a, b){
    const R = 6371000;
    const toRad = d => d*Math.PI/180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);
    const s = Math.sin(dLat/2)**2 + Math.sin(dLng/2)**2*Math.cos(lat1)*Math.cos(lat2);
    return 2*R*Math.asin(Math.sqrt(s));
  }

  // Robust elevation getter — supports multiple key names
  function readElevation(obj){
    if (!obj || typeof obj !== 'object') return null;
    for (const k of ['elev','elevation','alt','altitude','z']){
      if (obj[k] != null && !Number.isNaN(Number(obj[k]))) return Number(obj[k]);
    }
    return null;
  }

  // Resolve a point object {lat,lng,(elev?)} from various JSON shapes
  function asPoint(x){
    if (!x) return null;
    if (Array.isArray(x)){ // [lat,lng,(elev)]
      const [lat,lng,maybeElev] = x;
      const p = {lat:Number(lat), lng:Number(lng)};
      const elev = (maybeElev!=null) ? Number(maybeElev) : null;
      if (!Number.isNaN(elev)) p.elev = elev;
      return p;
    }
    const p = {lat:Number(x.lat ?? x.latitude), lng:Number(x.lng ?? x.lon ?? x.longitude)};
    const e = readElevation(x);
    if (e!=null) p.elev = e;
    return p;
  }

  function currentHole(){
    return state.courseData?.holes?.[state.holeIndex] ?? null;
  }

  function updateRoleUI(){
    els.roleText.textContent = state.role;
    // History button visible only for GUEST
    els.btnHistory.classList.toggle('hide', state.role !== 'GUEST');
    // Make Scorecard & History same width when both visible
    if (state.role === 'GUEST'){
      els.btnScorecard.style.minWidth = '120px';
      els.btnHistory.style.minWidth = '120px';
    } else {
      els.btnScorecard.style.minWidth = '';
      els.btnHistory.style.minWidth = '';
    }
  }

  function setMenu(open){
    els.menu.classList.toggle('hide', !open);
    // “bubble” only when open
    els.menuWrap.classList.toggle('open', open);
  }

  // Build course URL (uses plural folder and simple name)
  function courseUrl(name){
    const safe = String(name || '').toLowerCase();
    const cacheBust = Date.now();
    return `/tracklinq/public/courses/${safe}.json?cb=${cacheBust}`;
  }

  async function loadCourse(name){
    state.course = name;
    localStorage.setItem('tracklinq_course', name);
    els.courseText.textContent = name;
    try{
      const res = await fetch(courseUrl(name), {cache:'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      state.courseData = normalizeCourse(json);
      state.holeIndex = 0;
      renderHole();
      logDebug(`Loaded course: ${name}`);
    }catch(err){
      logDebug(`Failed to load course ${name}: ${err.message}`);
      alert(`Could not load course "${name}". Check file at /tracklinq/public/courses/${name}.json`);
    }
  }

  // Accept a couple of course JSON shapes; ensure holes[*].green.{front,mid,back} points
  function normalizeCourse(raw){
    const out = {...raw};
    if (!out.holes && Array.isArray(raw)) out.holes = raw;
    out.holes = (out.holes || []).map(h => {
      const hole = {...h};
      // Allow direct front/mid/back on hole or inside green
      const g = hole.green || {};
      const front = asPoint(hole.front || g.front);
      const mid   = asPoint(hole.mid   || g.mid   || g.middle);
      const back  = asPoint(hole.back  || g.back);
      hole.green = {front, mid, back};
      return hole;
    });
    return out;
  }

  function logDebug(msg){
    const ts = new Date().toLocaleTimeString();
    els.debug.textContent = `[${ts}] ${msg}\n` + els.debug.textContent;
  }

  /***********************
   * RENDER
   ***********************/
  function renderHole(){
    const hole = currentHole();
    if (!hole){
      els.holeChip.textContent = `Hole -- / --`;
      els.frontDist.textContent = els.midDist.textContent = els.backDist.textContent = '--';
      els.frontElev.textContent = els.midElev.textContent = els.backElev.textContent = 'Δ --';
      return;
    }
    const total = state.courseData.holes.length || 18;
    els.holeChip.textContent = `Hole ${state.holeIndex+1} / ${total}`;
    updateDistances();
  }

  function updateDistances(){
    const hole = currentHole();
    if (!hole || !state.position){ return; }

    const pos = state.position;
    const F = hole.green.front, M = hole.green.mid, B = hole.green.back;

    // Distances
    const dF = F ? distanceMeters(pos, F) : null;
    const dM = M ? distanceMeters(pos, M) : null;
    const dB = B ? distanceMeters(pos, B) : null;

    els.frontDist.textContent = dF!=null ? metersToDisplay(dF) : '--';
    els.midDist.textContent   = dM!=null ? metersToDisplay(dM) : '--';
    els.backDist.textContent  = dB!=null ? metersToDisplay(dB) : '--';

    // Elevation Δ target - player
    const ePos = readElevation(pos);
    const eF = readElevation(F);
    const eM = readElevation(M);
    const eB = readElevation(B);

    const dEF = (eF!=null && ePos!=null) ? (eF - ePos) : null;
    const dEM = (eM!=null && ePos!=null) ? (eM - ePos) : null;
    const dEB = (eB!=null && ePos!=null) ? (eB - ePos) : null;

    els.frontElev.textContent = elevToDisplay(dEF);
    els.midElev.textContent   = elevToDisplay(dEM);
    els.backElev.textContent  = elevToDisplay(dEB);

    // Live line
    els.liveInfo.textContent = `You: ${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}${ePos!=null?` • elev ${Math.round(ePos)}m`:''}`;
  }

  /***********************
   * GEO
   ***********************/
  function startGeolocation(){
    if (!navigator.geolocation){
      els.liveInfo.textContent = 'Geolocation not supported.';
      return;
    }
    navigator.geolocation.watchPosition(
      (p)=>{
        // We store optional elevation if available from course/device
        state.position = {
          lat: p.coords.latitude,
          lng: p.coords.longitude,
          // Some devices expose altitude; if not, we still compute target deltas when player elev missing -> shows "Δ --"
          elev: (p.coords.altitude != null && !Number.isNaN(p.coords.altitude)) ? Number(p.coords.altitude) : null
        };
        updateDistances();
      },
      (err)=>{
        els.liveInfo.textContent = `GPS error: ${err.message}`;
      },
      {enableHighAccuracy:true, maximumAge:1000, timeout:10000}
    );
  }

  /***********************
   * EVENTS
   ***********************/
  els.prevHole.addEventListener('click', ()=>{
    const n = state.courseData?.holes?.length||0;
    if (!n) return;
    state.holeIndex = (state.holeIndex - 1 + n) % n;
    renderHole();
  });
  els.nextHole.addEventListener('click', ()=>{
    const n = state.courseData?.holes?.length||0;
    if (!n) return;
    state.holeIndex = (state.holeIndex + 1) % n;
    renderHole();
  });
  els.center.addEventListener('click', ()=>{ startGeolocation(); });
  els.saveShot.addEventListener('click', ()=>{ logDebug('Shot saved (placeholder)'); });
  els.endHole.addEventListener('click', ()=>{ logDebug('Hole ended (placeholder)'); });

  // Role switching (quick toggle for testing)
  els.btnSwitchRole.addEventListener('click', ()=>{
    state.role = state.role === 'GUEST' ? 'CLUB' : 'GUEST';
    localStorage.setItem('tracklinq_role', state.role);
    updateRoleUI();
  });

  // History visibility is tied to role; handlers can stay
  els.btnScorecard.addEventListener('click', ()=>{ logDebug('Open Scorecard'); });
  els.btnHistory.addEventListener('click', ()=>{ if (state.role==='GUEST') logDebug('Open History'); });

  // Hamburger + menu (bubble only when open)
  let menuOpen = false;
  function toggleMenu(){
    menuOpen = !menuOpen;
    setMenu(menuOpen);
  }
  els.hamburger.addEventListener('click', toggleMenu);
  document.addEventListener('click', (e)=>{
    if (!els.menuWrap.contains(e.target) && !els.hamburger.contains(e.target)){
      if (menuOpen){ menuOpen=false; setMenu(false); }
    }
  });
  els.menu.addEventListener('click', (e)=>{
    if (e.target.matches('button[data-action]')){
      const action = e.target.getAttribute('data-action');
      if (action === 'selectCourse'){
        const name = prompt('Course file name (without .json):', state.course);
        if (name){ loadCourse(name.trim().toLowerCase()); }
      }
      if (action === 'selectClub'){
        alert('Club selection (placeholder)');
      }
      if (action === 'logout'){
        alert('Logout (placeholder)');
      }
      toggleMenu();
    }
  });

  /***********************
   * INIT
   ***********************/
  (function init(){
    // Restore role & course
    els.roleText.textContent = state.role;
    els.courseText.textContent = state.course;
    updateRoleUI();
    // Start GPS
    startGeolocation();
    // Load course (uses plural folder and new filename)
    loadCourse(state.course);
  })();
  </script>
</body>
</html>
