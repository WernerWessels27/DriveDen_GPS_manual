<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DriveDen • Course Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{
      --brand:#14532d; --brand2:#166534; --accent:#15803d;
      --panel:#ffffffee; --text:#111827; --muted:#6b7280;
    }
    html, body { height:100%; margin:0; }
    #map { height:100%; }

    .hud {
      position: fixed; top: 10px; left: 10px; z-index: 10000;
      background: var(--panel); padding: 10px 12px; border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      width: min(380px, calc(100% - 20px));
      max-height: 86vh; overflow:auto;
    }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin: 6px 0; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin:6px 0; }
    .row4 { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin:6px 0; }
    label { font-size:12px; color:var(--muted); }
    input[type="text"], input[type="number"], select, button {
      width:100%; padding:8px; border-radius:8px; border:1px solid #e5e7eb; font-size:14px;
    }
    button.primary { background: var(--accent); color:#fff; border:0; }
    button.warn { background:#b91c1c; color:#fff; border:0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e6f6ea; color:#14532d; font-weight:700; }
    .muted { color: var(--muted); font-size:12px; }
    .sep { height:1px; background:#e5e7eb; margin:10px 0; }

    .stat { display:flex; justify-content:space-between; font-size:13px; margin:4px 0; }
    .stat strong { font-variant-numeric: tabular-nums; }

    .footer {
      position: fixed; bottom:10px; left:10px; z-index:10000;
      background: var(--panel); padding:8px 10px; border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; gap:8px; align-items:center;
    }

    .nudge { display:grid; grid-template-columns:repeat(3,34px); gap:6px; justify-content:start; }
    .nudge button { height:34px; border-radius:8px; border:1px solid #d1d5db; background:#fff; }
    .caps { text-transform: uppercase; font-size:11px; letter-spacing:.04em; color:var(--muted); }

    .legend { font-size:12px; color:#374151; background:#fff; padding:4px 6px; border-radius:6px; box-shadow: 0 2px 8px rgba(0,0,0,.12); }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud">
    <div class="row">
      <div>
        <label>Course name</label>
        <input id="courseName" type="text" placeholder="e.g. Waterkloof Golf Club">
      </div>
      <div>
        <label>Course ID (file name)</label>
        <input id="courseId" type="text" placeholder="waterkloof-golf-club">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Hole</label>
        <select id="holeSelect"></select>
      </div>
      <div>
        <label>Par • Stroke</label>
        <div class="row" style="grid-template-columns:1fr 1fr; margin:0;">
          <input id="par" type="number" min="3" max="6" placeholder="Par">
          <input id="stroke" type="number" min="1" max="18" placeholder="SI">
        </div>
      </div>
    </div>

    <div class="row3">
      <button id="btnSetTee" class="primary">Set Tee</button>
      <button id="btnSetFront">Set Front</button>
      <button id="btnSetMid">Set Mid</button>
    </div>
    <div class="row3">
      <button id="btnSetBack">Set Back</button>
      <button id="btnClearHole" class="warn">Clear Hole</button>
      <button id="btnDeleteHole" class="warn">Delete Hole</button>
    </div>

    <div class="row" style="align-items:center;">
      <div>
        <label class="caps">Selected point</label>
        <div id="activePoint" class="pill">None</div>
      </div>
      <div>
        <label class="caps">Nudge (±0.5 m)</label>
        <div class="nudge">
          <button data-dy="0.5">▲</button>
          <button data-dx="0" data-dy="0" id="btnSnapGPS" title="Snap to current GPS">◎</button>
          <button data-dy="-0.5">▼</button>
          <button data-dx="-0.5">◀</button>
          <div></div>
          <button data-dx="0.5">▶</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row3">
      <button id="btnPrevHole">◀ Prev</button>
      <button id="btnSaveHole" class="primary">Save Hole</button>
      <button id="btnNextHole">Next ▶</button>
    </div>

    <div class="sep"></div>

    <div class="row3">
      <button id="btnNewCourse">New Course</button>
      <button id="btnImport">Import JSON</button>
      <button id="btnExport" class="primary">Export JSON</button>
    </div>
    <input id="fileInput" type="file" accept="application/json" style="display:none" />

    <div class="sep"></div>

    <div class="stat"><span>GPS</span><strong id="gpsStat">–</strong></div>
    <div class="stat"><span>→ Tee</span><strong id="dTee">–</strong></div>
    <div class="stat"><span>→ Front</span><strong id="dFront">–</strong></div>
    <div class="stat"><span>→ Mid</span><strong id="dMid">–</strong></div>
    <div class="stat"><span>→ Back</span><strong id="dBack">–</strong></div>
    <div class="muted">Tip: tap the map to set whichever point is “active”. Use the nudge arrows to fine-tune.</div>
  </div>

  <div class="footer">
    <span class="legend">● Tee</span>
    <span class="legend" style="color:#059669">● Front</span>
    <span class="legend" style="color:#b45309">● Mid</span>
    <span class="legend" style="color:#b91c1c">● Back</span>
    <span class="legend">— — Tee → Back preview</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
  // ---------- Map & helpers ----------
  const map = L.map('map', {zoomControl:true});
  const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19, attribution:'&copy; Esri, Maxar'});
  esri.addTo(map);
  map.setView([-25.7542, 28.2322], 16);

  function meters(a,b){
    const R=6371000, toRad=d=>d*Math.PI/180;
    const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
    const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
    const q=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
    return 2*R*Math.asin(Math.sqrt(q));
  }
  function fmtm(v){ return (v==null||Number.isNaN(v))?'–':`${Math.round(v)} m`; }

  // ---------- State ----------
  let course = { name:'', id:'', holes:[] };
  let currentIndex = 0;
  let activeKey = null; // 'tee' | 'front' | 'mid' | 'back'
  let lastPos = null;

  // ---------- UI refs ----------
  const courseName = document.getElementById('courseName');
  const courseId   = document.getElementById('courseId');
  const holeSel    = document.getElementById('holeSelect');
  const parInp     = document.getElementById('par');
  const strokeInp  = document.getElementById('stroke');
  const gpsStat    = document.getElementById('gpsStat');
  const dTee       = document.getElementById('dTee');
  const dFront     = document.getElementById('dFront');
  const dMid       = document.getElementById('dMid');
  const dBack      = document.getElementById('dBack');
  const activePoint= document.getElementById('activePoint');

  // ---------- Markers & preview ----------
  function mstyle(color){ return {radius:7, weight:2, color:color, fillColor:color, opacity:1, fillOpacity:.9}; }
  const mk = {
    tee:  null,
    front:null,
    mid:  null,
    back: null
  };
  let previewLine = null;

  function setMarker(which, pos){
    if(!pos) return;
    const colorMap = { tee:'#111827', front:'#059669', mid:'#b45309', back:'#b91c1c' };
    if(mk[which]) mk[which].setLatLng([pos.lat,pos.lng]);
    else mk[which] = L.circleMarker([pos.lat,pos.lng], mstyle(colorMap[which])).addTo(map).bindTooltip(which.toUpperCase());
  }
  function clearMarkers(){
    Object.keys(mk).forEach(k=>{ if(mk[k]){ map.removeLayer(mk[k]); mk[k]=null; }});
    if(previewLine){ map.removeLayer(previewLine); previewLine=null; }
  }
  function renderPreview(){
    if(previewLine){ map.removeLayer(previewLine); previewLine=null; }
    const h = course.holes[currentIndex]; if(!h) return;
    if(h.tee && (h.green?.back || h.green?.mid || h.green?.center)){
      const g = h.green.back || h.green.mid || h.green.center;
      previewLine = L.polyline([[h.tee.lat,h.tee.lng],[g.lat,g.lng]], {weight:3, dashArray:'6,8', color:'#111827', opacity:.8}).addTo(map);
      // Fit view gently when tee/back are first set
      // (only if we just added tee or back and no prior fit)
    }
  }

  // ---------- Hole management ----------
  function ensureHole(idx){
    while(course.holes.length <= idx) course.holes.push({ number:course.holes.length+1, par:null, strokeIndex:null, tee:null, green:{front:null, mid:null, back:null, center:null}, elevation:{front:null, mid:null, back:null} });
  }
  function refreshHoleSelect(){
    holeSel.innerHTML='';
    course.holes.forEach(h=>{
      const o=document.createElement('option');
      o.value=h.number; o.textContent=`Hole ${h.number}`;
      holeSel.appendChild(o);
    });
    holeSel.value = String(course.holes[currentIndex]?.number || 1);
  }
  function loadHoleToUI(){
    const h = course.holes[currentIndex]; if(!h) return;
    parInp.value = h.par ?? '';
    strokeInp.value = h.strokeIndex ?? '';
    clearMarkers();
    if(h.tee) setMarker('tee', h.tee);
    if(h.green?.front) setMarker('front', h.green.front);
    if(h.green?.mid)   setMarker('mid',   h.green.mid);
    if(h.green?.back)  setMarker('back',  h.green.back);
    renderPreview();
    // Fit view to visible points
    const pts = [h.tee, h.green?.front, h.green?.mid, h.green?.back].filter(Boolean);
    if(pts.length){
      const b = L.latLngBounds(pts.map(p=>[p.lat,p.lng]));
      map.fitBounds(b.pad(0.25));
    }
    updateDistances();
  }
  function saveUItoHole(){
    const h = course.holes[currentIndex]; if(!h) return;
    h.par = parInp.value ? Number(parInp.value) : null;
    h.strokeIndex = strokeInp.value ? Number(strokeInp.value) : null;
  }

  // ---------- Active point selection ----------
  function setActive(which){
    activeKey = which;
    activePoint.textContent = which ? which.toUpperCase() : 'None';
  }

  // ---------- Map click to set active point ----------
  map.on('click', e=>{
    if(!activeKey) return;
    const p = {lat:e.latlng.lat, lng:e.latlng.lng};
    const h = course.holes[currentIndex]; if(!h) return;
    if(activeKey==='tee'){
      h.tee = p; setMarker('tee', p);
    } else {
      if(!h.green) h.green={};
      h.green[activeKey] = p; setMarker(activeKey, p);
      if(activeKey==='mid' && !h.green.center) h.green.center = p; // convenience
    }
    renderPreview();
    updateDistances();
  });

  // ---------- Nudge (approx 0.5 m) ----------
  function metersToDegLat(m){ return m / 111320; }
  function metersToDegLng(m, atLat){ return m / (111320 * Math.cos(atLat * Math.PI/180)); }

  document.querySelectorAll('.nudge button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!activeKey) return;
      const h = course.holes[currentIndex]; if(!h) return;
      const target = activeKey==='tee' ? h.tee : h.green?.[activeKey];
      if(!target) return;
      const dy = Number(btn.dataset.dy||0);
      const dx = Number(btn.dataset.dx||0);
      if(btn.id === 'btnSnapGPS' && lastPos){
        target.lat = lastPos.lat; target.lng = lastPos.lng;
      } else if(dx||dy){
        target.lat += metersToDegLat(dy);
        target.lng += metersToDegLng(dx, target.lat);
      }
      if(activeKey==='tee') setMarker('tee', target);
      else setMarker(activeKey, target);
      renderPreview();
      updateDistances();
    });
  });

  // ---------- Buttons ----------
  document.getElementById('btnSetTee').onclick  = ()=>setActive('tee');
  document.getElementById('btnSetFront').onclick= ()=>setActive('front');
  document.getElementById('btnSetMid').onclick  = ()=>setActive('mid');
  document.getElementById('btnSetBack').onclick = ()=>setActive('back');

  document.getElementById('btnSaveHole').onclick= ()=>{
    saveUItoHole();
    persistLocalDraft();
  };
  document.getElementById('btnPrevHole').onclick= ()=>{
    if(currentIndex>0){ currentIndex--; refreshHoleSelect(); loadHoleToUI(); }
  };
  document.getElementById('btnNextHole').onclick= ()=>{
    currentIndex = Math.min(currentIndex+1, course.holes.length); // allow step into new
    ensureHole(currentIndex);
    refreshHoleSelect(); loadHoleToUI();
  };
  holeSel.onchange = ()=>{
    const n = Number(holeSel.value);
    const idx = course.holes.findIndex(h=>h.number===n);
    if(idx>=0){ currentIndex = idx; loadHoleToUI(); }
  };

  document.getElementById('btnClearHole').onclick= ()=>{
    const h = course.holes[currentIndex]; if(!h) return;
    h.tee=null; h.green={front:null,mid:null,back:null,center:null};
    clearMarkers(); renderPreview(); updateDistances();
  };
  document.getElementById('btnDeleteHole').onclick= ()=>{
    if(!confirm('Delete this hole?')) return;
    course.holes.splice(currentIndex,1);
    // re-number
    course.holes.forEach((h,i)=>h.number=i+1);
    currentIndex=Math.max(0,currentIndex-1);
    refreshHoleSelect(); loadHoleToUI(); persistLocalDraft();
  };

  document.getElementById('btnNewCourse').onclick= ()=>{
    if(!confirm('Start a new blank course?')) return;
    course = { name:'', id:'', holes:[] };
    currentIndex = 0;
    ensureHole(0);
    courseName.value=''; courseId.value='';
    refreshHoleSelect(); loadHoleToUI(); persistLocalDraft();
  };

  document.getElementById('btnExport').onclick= ()=>{
    saveUItoHole();
    course.name = courseName.value.trim() || course.name || 'Unnamed Course';
    course.id   = (courseId.value.trim() || course.id || 'course').toLowerCase();
    // Build export shape (backwards compatible)
    const exportObj = {
      name: course.name,
      id: course.id,
      holes: course.holes.map(h=>({
        number: h.number,
        par: h.par,
        strokeIndex: h.strokeIndex,
        tee: h.tee || null,
        green: {
          center: h.green?.center || h.green?.mid || null,
          front:  h.green?.front  || null,
          mid:    h.green?.mid    || null,
          back:   h.green?.back   || null
        },
        elevation: {
          front: h.elevation?.front ?? null,
          mid:   h.elevation?.mid   ?? null,
          back:  h.elevation?.back  ?? null
        }
      }))
    };
    const blob = new Blob([JSON.stringify(exportObj,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${exportObj.id}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  const fileInput = document.getElementById('fileInput');
  document.getElementById('btnImport').onclick= ()=> fileInput.click();
  fileInput.onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    try{
      const obj = JSON.parse(txt);
      // Accept both root {course} and flattened
      const root = obj.course || obj;
      const holes = (root.holes||[]).map(h=>({
        number: (h.number??h.hole??h.holeNumber??null)*1,
        par:    (h.par!=null)?Number(h.par):null,
        strokeIndex: (h.strokeIndex??h.stroke??h.si??null)*1 || null,
        tee:    h.tee || null,
        green: {
          center: h.green?.center || h.green?.mid || null,
          front:  h.green?.front  || null,
          mid:    h.green?.mid    || null,
          back:   h.green?.back   || null
        },
        elevation: {
          front: h.elevation?.front ?? null,
          mid:   h.elevation?.mid   ?? null,
          back:  h.elevation?.back  ?? null
        }
      })).filter(h=>Number.isFinite(h.number)).sort((a,b)=>a.number-b.number);

      course = { name: root.name||'', id: root.id||'', holes };
      currentIndex = 0;
      courseName.value = course.name;
      courseId.value   = course.id;
      ensureHole(0);
      refreshHoleSelect(); loadHoleToUI(); persistLocalDraft();
      alert('Imported OK');
    }catch(err){
      alert('Import failed: '+err.message);
    }
  };

  // ---------- GPS & distances ----------
  let movedOnce=false;
  if('geolocation' in navigator){
    navigator.geolocation.watchPosition(p=>{
      lastPos = {lat:p.coords.latitude, lng:p.coords.longitude};
      gpsStat.textContent = `Acc: ${Math.round(p.coords.accuracy||0)} m`;
      if(!movedOnce){ map.setView([lastPos.lat,lastPos.lng], 17); movedOnce=true; }
      updateDistances();
    }, err=>{ gpsStat.textContent = err.message; }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
  } else {
    gpsStat.textContent = 'Geolocation not supported';
  }

  function updateDistances(){
    const h = course.holes[currentIndex]; if(!h || !lastPos){ dTee.textContent=dFront.textContent=dMid.textContent=dBack.textContent='–'; return; }
    dTee.textContent   = fmtm(h.tee   ? meters(lastPos, h.tee) : null);
    dFront.textContent = fmtm(h.green?.front ? meters(lastPos, h.green.front) : null);
    dMid.textContent   = fmtm(h.green?.mid   ? meters(lastPos, h.green.mid)   : (h.green?.center ? meters(lastPos,h.green.center):null));
    dBack.textContent  = fmtm(h.green?.back  ? meters(lastPos, h.green.back)  : null);
  }

  // ---------- Local draft persistence ----------
  function persistLocalDraft(){
    try{
      const draft = { course, currentIndex };
      localStorage.setItem('dd_admin_draft', JSON.stringify(draft));
    }catch{}
  }
  function loadLocalDraft(){
    try{
      const raw = localStorage.getItem('dd_admin_draft');
      if(!raw) return false;
      const draft = JSON.parse(raw);
      if(!draft?.course?.holes) return false;
      course = draft.course; currentIndex = draft.currentIndex||0;
      courseName.value = course.name||''; courseId.value = course.id||'';
      ensureHole(0); refreshHoleSelect(); loadHoleToUI();
      return true;
    }catch{ return false; }
  }

  // ---------- Init ----------
  if(!loadLocalDraft()){
    ensureHole(0);
    refreshHoleSelect();
    loadHoleToUI();
  }
  </script>
</body>
</html>
