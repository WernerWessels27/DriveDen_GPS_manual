<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>DriveDen – Course Admin (3×3 Elevation + Nudge)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  :root{ --brand:#14532d; --panel:#ffffffee; --muted:#6b7280; --accent:#15803d; }
  html, body, #map { height:100%; margin:0; }
  .hud{ position:fixed; top:10px; left:10px; z-index:9999; background:var(--panel); padding:10px 12px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.15); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; width:360px; max-width:calc(100% - 20px);}
  .hud h3{ margin:0 0 8px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin:6px 0; }
  .row-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin:6px 0; }
  .row-full{ display:block; margin:8px 0; }
  input, select, button{ padding:8px; font-size:14px; }
  button.primary{ background:var(--accent); color:#fff; border:0; border-radius:8px; cursor:pointer; }
  button{ border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; cursor:pointer; }
  .muted{ color:var(--muted); font-size:12px; }
  .status{ margin-top:6px; font-size:12px; }
  .section{ margin-top:10px; padding-top:8px; border-top:1px dashed #e5e7eb; }
  .nudgeRow{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; }
  .nudges{ display:grid; grid-template-columns: repeat(3,36px); grid-template-rows: repeat(2,36px); gap:6px; align-items:center; justify-items:center; }
  .nudges .spacer{ visibility:hidden; }
  .chip{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef7f0; color:#14532d; font-weight:700; font-size:12px; }
  .fab-left{ position:fixed; left:12px; bottom:12px; z-index:10001; width:52px; height:52px; border-radius:50%; border:0; font-size:22px; background:#14532d; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.2); cursor:pointer; display:none; }
  .tiny{ font-size:12px; color:#374151; }
  code.small{ font-size:11px; }
</style>
</head>
<body>
<div id="map"></div>

<div class="hud">
  <h3>Course Admin</h3>

  <div class="row">
    <input id="courseName" placeholder="Course name (e.g., Waterkloof Golf Club)" />
    <input id="courseId" placeholder="course-id (e.g., waterkloof-golf-club)" />
  </div>

  <div class="row">
    <select id="holeSelect"></select>
    <input id="par" type="number" placeholder="Par" />
  </div>
  <div class="row">
    <input id="stroke" type="number" placeholder="Stroke index" />
    <button id="saveHole" class="primary">Save/Update Hole</button>
  </div>

  <div class="section">
    <div class="row-3">
      <button id="setFront">Set Front (GPS)</button>
      <button id="setMid">Set Mid (GPS)</button>
      <button id="setBack">Set Back (GPS)</button>
    </div>
    <div class="row">
      <select id="placeMode">
        <option value="">Click-to-place: Off</option>
        <option value="front">Click to place: Front</option>
        <option value="mid">Click to place: Mid</option>
        <option value="back">Click to place: Back</option>
      </select>
      <button id="clearPoint">Clear F/M/B for hole</button>
    </div>
    <div class="muted">Tip: Select a click-to-place mode and click imagery to drop Front/Mid/Back. Elevation bakes automatically (3×3 median).</div>
  </div>

  <!-- NUDGE CONTROLS -->
  <div class="section">
    <div class="nudgeRow">
      <div><strong>Front</strong> <span id="frontMeta" class="tiny"></span></div>
      <div class="nudges">
        <button data-nudge="front:0:-1">↑</button>
        <span class="spacer"></span>
        <button data-nudge="front:0:1">↓</button>
        <button data-nudge="front:-1:0">←</button>
        <span class="chip">1 m</span>
        <button data-nudge="front:1:0">→</button>
      </div>
    </div>
    <div class="nudgeRow">
      <div><strong>Mid</strong> <span id="midMeta" class="tiny"></span></div>
      <div class="nudges">
        <button data-nudge="mid:0:-1">↑</button>
        <span class="spacer"></span>
        <button data-nudge="mid:0:1">↓</button>
        <button data-nudge="mid:-1:0">←</button>
        <span class="chip">1 m</span>
        <button data-nudge="mid:1:0">→</button>
      </div>
    </div>
    <div class="nudgeRow">
      <div><strong>Back</strong> <span id="backMeta" class="tiny"></span></div>
      <div class="nudges">
        <button data-nudge="back:0:-1">↑</button>
        <span class="spacer"></span>
        <button data-nudge="back:0:1">↓</button>
        <button data-nudge="back:-1:0">←</button>
        <span class="chip">1 m</span>
        <button data-nudge="back:1:0">→</button>
      </div>
    </div>
    <div class="muted">Nudges move a point by 1 m (N/S/E/W) and re-bake its elevation. Hold to repeat on mobile.</div>
  </div>

  <div class="section">
    <div class="row">
      <button id="recomputeElev" title="Re-sample 3×3 and re-bake all holes' elevations">Recompute Elevations</button>
      <button id="clearCourse">Clear ALL holes</button>
    </div>
    <div class="row">
      <button id="prevHole">◀ Prev Hole</button>
      <button id="nextHole">Next Hole ▶</button>
    </div>
    <div class="row">
      <button id="exportJson" class="primary">Export JSON</button>
      <button id="importJson">Import JSON</button>
    </div>
  </div>

  <div class="status" id="status">Ready</div>
</div>

<button id="recenterBtn" class="fab-left" title="Recenter">＋</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
  // ==== Map & layers ====
  const esriImagery = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    {maxZoom:19, attribution:'© Esri, Maxar'}
  );
  const map = L.map('map',{layers:[esriImagery]});
  map.setView([-25.7542,28.2322], 16);

  // Cart icon (same as player app)
  const cartSvg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" viewBox="0 0 40 32"><rect x="5" y="10" width="24" height="10" rx="2" ry="2" fill="#1f2937"/><polygon points="5,10 15,4 29,4 29,10" fill="#0ea5b7"/><circle cx="13" cy="24" r="4" fill="#111827"/><circle cx="13" cy="24" r="2" fill="#e5e7eb"/><circle cx="27" cy="24" r="4" fill="#111827"/><circle cx="27" cy="24" r="2" fill="#e5e7eb"/><rect x="30" y="12" width="6" height="2" rx="1" fill="#111827"/><circle cx="34" cy="16" r="2" fill="#14b8a6"/></svg>`);
  const cartIcon = L.icon({ iconUrl:`data:image/svg+xml;utf8,${cartSvg}`, iconSize:[28,22], iconAnchor:[14,11] });
  const you = L.marker([0,0], { icon: cartIcon }).addTo(map);

  let follow=true, movedOnce=false, lastPos=null;
  map.on('dragstart',()=>{follow=false; document.getElementById('recenterBtn').style.display='block';});
  map.on('zoomstart',()=>{follow=false; document.getElementById('recenterBtn').style.display='block';});
  document.getElementById('recenterBtn').onclick=()=>{ if(!lastPos) return; follow=true; map.setView([lastPos.lat,lastPos.lng], map.getZoom()||17); document.getElementById('recenterBtn').style.display='none'; };

  if('geolocation' in navigator){
    navigator.geolocation.watchPosition(pos=>{
      const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
      lastPos=p; you.setLatLng([p.lat,p.lng]);
      if(follow){ map.setView([p.lat,p.lng], map.getZoom()||17); document.getElementById('recenterBtn').style.display='none'; }
      if(!movedOnce){ map.setView([p.lat,p.lng],17); movedOnce=true; }
      setStatus(`GPS: ±${Math.round(pos.coords.accuracy||0)} m`);
    },err=>setStatus(err.message),{enableHighAccuracy:true, maximumAge:1000, timeout:10000});
  } else setStatus('Geolocation not supported');

  // ==== Course data model ====
  const statusEl=document.getElementById('status');
  function setStatus(txt){ statusEl.textContent=txt; }

  const course = {
    id:'', name:'',
    holes: Array.from({length:18}, (_,i)=>({
      number:i+1, par:null, strokeIndex:null,
      green:{ front:null, mid:null, back:null },
      elevation:{ front:null, mid:null, back:null }
    }))
  };

  const holeSel = document.getElementById('holeSelect');
  for(let i=1;i<=18;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent='Hole '+i; holeSel.appendChild(o); }
  const parEl=document.getElementById('par');
  const strokeEl=document.getElementById('stroke');
  const placeModeSel=document.getElementById('placeMode');

  function syncHeader(){
    document.getElementById('courseId').value=course.id||'';
    document.getElementById('courseName').value=course.name||'';
  }
  function loadHoleUI(idx){
    const h=course.holes[idx];
    holeSel.value=String(h.number);
    parEl.value=h.par??'';
    strokeEl.value=h.strokeIndex??'';
    renderMarkers(h);
    updateMetaLabels();
  }

  // ==== Markers ====
  const markers={};
  function mstyle(n){ const p={front:['#059669','#10b981'],mid:['#b45309','#f59e0b'],back:['#b91c1c','#ef4444']}[n]||['#111827','#374151']; return {radius:7,weight:2,opacity:1,fillOpacity:.9,color:p[0],fillColor:p[1]}; }
  function setMarker(name, pos, label){
    if(!pos) return;
    if(markers[name]){ markers[name].setLatLng([pos.lat,pos.lng]); return; }
    markers[name]=L.circleMarker([pos.lat,pos.lng], mstyle(name)).addTo(map).bindTooltip(label||name);
  }
  function clearMarkers(){ ['front','mid','back'].forEach(k=>{ if(markers[k]){ map.removeLayer(markers[k]); delete markers[k]; } }); }
  function renderMarkers(h){
    clearMarkers();
    if(h.green.front) setMarker('front',h.green.front,'Front');
    if(h.green.mid)   setMarker('mid',  h.green.mid,  'Mid');
    if(h.green.back)  setMarker('back', h.green.back, 'Back');
    fitIfAny(h);
  }
  function fitIfAny(h){
    const pts=[h.green.front,h.green.mid,h.green.back].filter(Boolean);
    if(pts.length){ map.fitBounds(L.latLngBounds(pts.map(p=>[p.lat,p.lng]))); }
  }

  let currentIdx=0;
  syncHeader(); loadHoleUI(currentIdx);

  document.getElementById('prevHole').onclick=()=>{ currentIdx=(currentIdx+17)%18; loadHoleUI(currentIdx); };
  document.getElementById('nextHole').onclick=()=>{ currentIdx=(currentIdx+1)%18;  loadHoleUI(currentIdx); };

  document.getElementById('courseId').addEventListener('input',e=>course.id=(e.target.value||'').trim());
  document.getElementById('courseName').addEventListener('input',e=>course.name=(e.target.value||'').trim());

  document.getElementById('saveHole').onclick=()=>{
    const h=course.holes[currentIdx];
    h.par = parEl.value?Number(parEl.value):null;
    h.strokeIndex = strokeEl.value?Number(strokeEl.value):null;
    setStatus(`Saved Hole ${h.number}`);
  };
  document.getElementById('clearPoint').onclick=()=>{
    const h=course.holes[currentIdx];
    h.green={front:null,mid:null,back:null};
    h.elevation={front:null,mid:null,back:null};
    renderMarkers(h);
    setStatus(`Cleared F/M/B for Hole ${h.number}`);
  };
  document.getElementById('clearCourse').onclick=()=>{
    if(!confirm('Clear ALL holes?')) return;
    course.holes = Array.from({length:18}, (_,i)=>({
      number:i+1, par:null, strokeIndex:null,
      green:{ front:null, mid:null, back:null },
      elevation:{ front:null, mid:null, back:null }
    }));
    loadHoleUI(currentIdx);
    setStatus('Cleared course');
  };

  // ==== Elevation sampling via /elevation proxy (3×3 median) ====
  async function elevAt(lat,lng){
    try{
      const r=await fetch(`/elevation?lat=${lat}&lng=${lng}`);
      if(r.ok){ const j=await r.json(); const v=j?.results?.[0]?.elevation; if(typeof v==='number') return v; }
    }catch{}
    return null;
  }
  function offsetMeters(lat,lng,dx,dy){
    // approximate: dx east-west (m), dy north-south (m)
    const dLat = dy / 111320; // m per deg latitude
    const dLng = dx / (111320 * Math.cos(lat * Math.PI/180));
    return { lat: lat + dLat, lng: lng + dLng };
  }
  async function sampleMedian(lat,lng){
    // 3x3 grid around point, spacing 10 m
    const spacing=10;
    const pts=[];
    for(const oy of [-spacing,0,spacing]){
      for(const ox of [-spacing,0,spacing]){
        pts.push(offsetMeters(lat,lng,ox,oy));
      }
    }
    const vals=[];
    for(const p of pts){
      const v=await elevAt(p.lat,p.lng);
      if(typeof v==='number') vals.push(v);
    }
    if(!vals.length) return null;
    vals.sort((a,b)=>a-b);
    const mid = Math.floor(vals.length/2);
    return (vals.length%2)? vals[mid] : Math.round((vals[mid-1]+vals[mid])/2);
  }

  // ==== Set point helpers (GPS or click) ====
  async function setPoint(which, posOpt){
    const h=course.holes[currentIdx];
    let pos = posOpt || lastPos;
    if(!pos){ setStatus('No position (GPS or click)'); return; }

    // Save point + marker
    h.green[which] = {lat:pos.lat, lng:pos.lng};
    renderMarkers(h);
    updateMetaLabels();
    setStatus(`Saved ${which} @ ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}. Sampling elevation…`);

    // Bake elevation (median 3x3)
    const z = await sampleMedian(pos.lat, pos.lng);
    h.elevation[which] = (typeof z==='number')? z : null;
    updateMetaLabels();
    setStatus(`Saved ${which} elevation: ${z!=null?z+' m':'–'}`);
  }

  // Buttons: set from GPS
  document.getElementById('setFront').onclick=()=>setPoint('front');
  document.getElementById('setMid').onclick=()=>setPoint('mid');
  document.getElementById('setBack').onclick=()=>setPoint('back');

  // Click-to-place mode
  let placeMode = '';
  placeModeSel.addEventListener('change', ()=>{ placeMode = placeModeSel.value; });
  map.on('click', (e)=>{
    if(!placeMode) return;
    setPoint(placeMode, {lat:e.latlng.lat, lng:e.latlng.lng});
  });

  // Nudge controls (1 m)
  document.querySelectorAll('[data-nudge]').forEach(btn=>{
    btn.addEventListener('click', async (ev)=>{
      const [which, dxmStr, dymStr] = ev.currentTarget.getAttribute('data-nudge').split(':');
      const dxm = Number(dxmStr), dym = Number(dymStr);
      const h=course.holes[currentIdx];
      const p=h.green[which];
      if(!p){ setStatus(`No ${which} point set yet`); return; }
      const moved = offsetMeters(p.lat, p.lng, dxm, dym);
      h.green[which] = moved;
      renderMarkers(h);
      updateMetaLabels();
      setStatus(`Nudged ${which} by (${dxm}m, ${dym}m). Re-baking elevation…`);
      const z = await sampleMedian(moved.lat, moved.lng);
      h.elevation[which] = (typeof z==='number')? z : null;
      updateMetaLabels();
      setStatus(`Saved ${which} elevation: ${z!=null?z+' m':'–'}`);
    });
  });

  // Re-bake everything
  document.getElementById('recomputeElev').onclick=async()=>{
    setStatus('Recomputing elevations for all holes…');
    for(const h of course.holes){
      for(const key of ['front','mid','back']){
        const p=h.green[key];
        if(!p) continue;
        const z=await sampleMedian(p.lat,p.lng);
        h.elevation[key]=(typeof z==='number')?z:null;
        updateMetaLabels();
      }
    }
    setStatus('Re-bake complete ✔');
  };

  // Meta labels under nudge titles
  function fmtLatLng(p){ return p? `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}` : '–'; }
  function fmtElev(v){ return (typeof v==='number')? `${Math.round(v)} m` : '–'; }
  function updateMetaLabels(){
    const h=course.holes[currentIdx];
    document.getElementById('frontMeta').textContent = `(${fmtLatLng(h.green.front)}) • elev ${fmtElev(h.elevation.front)}`;
    document.getElementById('midMeta').textContent   = `(${fmtLatLng(h.green.mid)}) • elev ${fmtElev(h.elevation.mid)}`;
    document.getElementById('backMeta').textContent  = `(${fmtLatLng(h.green.back)}) • elev ${fmtElev(h.elevation.back)}`;
  }

  // ==== Export / Import ====
  document.getElementById('exportJson').onclick=()=>{
    const data = {
      name: course.name || '',
      id: course.id || '',
      holes: course.holes.map(h=>({
        number:h.number,
        par:h.par,
        strokeIndex:h.strokeIndex,
        green:h.green,
        elevation:h.elevation
      }))
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=(course.id || 'course') + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  document.getElementById('importJson').onclick=()=>{
    const inp=document.createElement('input');
    inp.type='file'; inp.accept='application/json';
    inp.onchange=async ()=>{
      const f=inp.files[0]; if(!f) return;
      const txt=await f.text(); const js=JSON.parse(txt);
      course.id = js.id || course.id;
      course.name = js.name || course.name;
      if(Array.isArray(js.holes)){
        for(const h of js.holes){
          const idx=(h.number? (h.number-1): null);
          if(idx==null || idx<0 || idx>17) continue;
          course.holes[idx] = {
            number: h.number,
            par: h.par ?? null,
            strokeIndex: h.strokeIndex ?? h.stroke ?? null,
            green: {
              front: h.green?.front ?? null,
              mid:   h.green?.mid   ?? h.green?.center ?? null,
              back:  h.green?.back  ?? null
            },
            elevation: {
              front: h.elevation?.front ?? null,
              mid:   h.elevation?.mid   ?? null,
              back:  h.elevation?.back  ?? null
            }
          };
        }
      }
      syncHeader(); loadHoleUI(currentIdx);
      setStatus('Imported course JSON ✔');
    };
    inp.click();
  };
</script>
</body>
</html>
