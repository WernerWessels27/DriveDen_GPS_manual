<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DriveDen GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#14532d" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />

  <style>
    :root{
      --brand:#14532d; --brand-2:#0b7a3a;
      --panel:#ffffffee; --text:#0f172a; --muted:#64748b;
      --accent:#15803d; --accent-2:#0ea5b7;
      --badge:#f1f5f9;
    }
    *{ box-sizing:border-box }
    html, body, #map { height:100%; margin:0; }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; color:var(--text); }

    /* Top HUD */
    .topbar{
      position:fixed; top:10px; left:10px; right:10px; z-index:10001;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .chip{
      background:var(--panel); padding:8px 10px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.15);
      display:flex; align-items:center; gap:8px; min-height:42px;
    }
    .brand{ gap:8px; font-weight:700; }
    .brand img{ height:22px; width:auto; display:block; }

    .holeNav{ gap:10px; }
    .holeBtn{
      border:0; background:var(--brand); color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700;
    }
    .holeTitle{ font-weight:800; font-size:14px; }
    .sub{ font-size:12px; color:var(--muted); }

    .distPanel{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .distBox{
      background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; min-width:92px;
    }
    .label{ font-size:12px; color:var(--muted); }
    .big{ font-size:18px; font-weight:800; }

    .stats{ gap:8px; }
    .stat{ font-size:12px; color:var(--muted); }
    .windsock{ width:18px; height:18px; }

    /* Floating buttons */
    .fab{
      position:fixed; right:12px; bottom:12px; z-index:10002;
      display:flex; flex-direction:column; gap:10px;
    }
    .fab button{
      width:52px; height:52px; border-radius:50%; border:0; background:var(--brand); color:#fff; font-size:22px;
      box-shadow:0 6px 16px rgba(0,0,0,.2); cursor:pointer;
    }
    .fab-left{
      position:fixed; left:12px; bottom:12px; z-index:10002;
      width:52px; height:52px; border-radius:50%; border:0; background:#1f2937; color:#fff; font-size:20px;
      box-shadow:0 6px 16px rgba(0,0,0,.2); cursor:pointer; display:none;
    }

    /* Bottom panel */
    .bottombar{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:10001; display:flex; gap:10px; flex-wrap:wrap;
    }
    .bottomChip{
      background:var(--panel); padding:8px 10px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.15);
      display:flex; align-items:center; gap:10px; min-height:42px;
    }
    .toggle{ border:1px solid #e5e7eb; background:#fff; color:#111; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .toggle.active{ background:var(--brand); color:#fff; border-color:transparent; }

    /* Measure info bubble */
    .measureInfo{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:76px; z-index:10002; background:var(--panel); padding:8px 10px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.15);
      display:none; gap:8px; align-items:center; font-weight:700;
    }
    .measureInfo.show{ display:flex; }
    .measureClose{ background:#fff; border:1px solid #e5e7eb; color:#111; border-radius:8px; padding:4px 8px; cursor:pointer; font-weight:700; }

    /* Scorecard (kept compact) */
    .scorecard{ position:fixed; left:50%; bottom:76px; transform:translateX(-50%); width:min(940px,calc(100% - 20px));
      max-height:70vh; overflow:auto; background:var(--panel); color:var(--text); border-radius:12px; box-shadow:0 14px 30px rgba(0,0,0,.25);
      padding:12px; z-index:10002; display:none; }
    .scorecard.show{ display:block; }
    .sc-row{ display:grid; grid-template-columns: 38px 46px repeat(4, minmax(82px,1fr)); gap:8px; align-items:center; padding:4px 0; border-bottom:1px solid #e5e7eb; }
    .sc-head{ font-weight:700; background:#f9fafb; border-radius:8px; padding:6px 8px; }
    .sc-button{ background:var(--brand-2); color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; }

    /* Small helpers */
    .muted{ color:var(--muted); font-size:12px; }
    .sep{ width:1px; height:18px; background:#e5e7eb; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- TOP -->
  <div class="topbar">
    <div class="chip brand">
      <!-- Replace with your logo path if you have one -->
      <img src="/icons/icon-192.png" alt="DriveDen" />
      <div>
        <div class="holeTitle" id="holeTitle">Hole ‚Äì</div>
        <div class="sub" id="holeMeta">Par ‚Äì ‚Ä¢ Stroke ‚Äì</div>
      </div>
    </div>

    <div class="chip holeNav">
      <button class="holeBtn" id="prevHole">‚óÄ</button>
      <div id="courseName" class="sub" style="min-width:140px;text-align:center;">No course loaded</div>
      <button class="holeBtn" id="nextHole">‚ñ∂</button>
    </div>

    <div class="chip distPanel">
      <div class="distBox">
        <div class="label">Front</div>
        <div class="big" id="dFront">‚Äì</div>
        <div class="muted" id="eFront">‚Äì</div>
      </div>
      <div class="distBox">
        <div class="label">Middle</div>
        <div class="big" id="dMid">‚Äì</div>
        <div class="muted" id="eMid">‚Äì</div>
      </div>
      <div class="distBox">
        <div class="label">Back</div>
        <div class="big" id="dBack">‚Äì</div>
        <div class="muted" id="eBack">‚Äì</div>
      </div>
    </div>

    <div class="chip stats">
      <div class="stat" id="gpsStat">GPS: ‚Ä¶</div>
      <div class="sep"></div>
      <img class="windsock" id="windIcon" alt="wind" />
      <div class="stat" id="windStat">‚Äì m/s</div>
    </div>
  </div>

  <!-- FLOATING BUTTONS -->
  <div class="fab">
    <!-- Scorecard toggle -->
    <button id="btnScore" title="Scorecard">üóíÔ∏è</button>
    <!-- Measure marker -->
    <button id="btnMeasure" title="Measure">üìè</button>
    <!-- Course picker -->
    <button id="btnCourse" title="Load course">üîé</button>
    <!-- Contours toggle -->
    <button id="btnContours" title="Contours">‚õ∞Ô∏è</button>
  </div>
  <button id="recenterBtn" class="fab-left" title="Recenter">‚úö</button>

  <!-- Bottom bar -->
  <div class="bottombar">
    <div class="bottomChip" id="coursePicker" style="display:none; flex-wrap:wrap;">
      <div class="label" style="min-width:100%;">Select Course</div>
      <select id="courseSelect"></select>
      <button class="toggle" id="loadCourse">Load</button>
      <span class="muted" id="courseCount"></span>
    </div>
    <div class="measureInfo" id="measureInfo">
      <span id="measureText">0 m</span>
      <button class="measureClose" id="measureClose">‚úï Clear</button>
    </div>
  </div>

  <!-- Scorecard (minimal) -->
  <div class="scorecard" id="scorecard">
    <div class="sc-head">Scorecard <button class="sc-button" id="scClose" style="float:right;">Close</button></div>
    <div class="sc-row" style="font-weight:700;">
      <div>#</div><div>Par</div><div>P1</div><div>P2</div><div>P3</div><div>P4</div>
    </div>
    <div id="scRows"></div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    // ===== Map layers =====
    const esriImagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 19, attribution: '¬© Esri, Maxar' }
    );

    // Contours overlay (fixed: more visible + correct z-index)
    const contours = L.tileLayer(
      'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
      { maxZoom: 17, opacity: 0.55, zIndex: 500, attribution: '¬© OpenStreetMap, SRTM ¬∑ OpenTopoMap (CC-BY-SA)' }
    );

    const map = L.map('map', { layers: [esriImagery] });
    map.setView([-25.7542, 28.2322], 16);

    // ===== Player marker (cart icon) =====
    const cartSvg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" viewBox="0 0 40 32"><rect x="5" y="10" width="24" height="10" rx="2" ry="2" fill="#1f2937"/><polygon points="5,10 15,4 29,4 29,10" fill="#0ea5b7"/><circle cx="13" cy="24" r="4" fill="#111827"/><circle cx="13" cy="24" r="2" fill="#e5e7eb"/><circle cx="27" cy="24" r="4" fill="#111827"/><circle cx="27" cy="24" r="2" fill="#e5e7eb"/><rect x="30" y="12" width="6" height="2" rx="1" fill="#111827"/><circle cx="34" cy="16" r="2" fill="#14b8a6"/></svg>`);
    const cartIcon = L.icon({ iconUrl:`data:image/svg+xml;utf8,${cartSvg}`, iconSize:[28,22], iconAnchor:[14,11] });
    const you = L.marker([0,0], { icon: cartIcon }).addTo(map);

    let follow=true, movedOnce=false, lastPos=null;
    map.on('dragstart',()=>{follow=false; document.getElementById('recenterBtn').style.display='block';});
    map.on('zoomstart',()=>{follow=false; document.getElementById('recenterBtn').style.display='block';});
    document.getElementById('recenterBtn').onclick=()=>{ if(!lastPos) return; follow=true; map.setView([lastPos.lat,lastPos.lng], map.getZoom()||17); document.getElementById('recenterBtn').style.display='none'; };

    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(pos=>{
        const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
        lastPos=p; you.setLatLng([p.lat,p.lng]);
        if(follow){ map.setView([p.lat,p.lng], map.getZoom()||17); document.getElementById('recenterBtn').style.display='none'; }
        if(!movedOnce){ map.setView([p.lat,p.lng],17); movedOnce=true; }
        document.getElementById('gpsStat').textContent = `GPS: ¬±${Math.round(pos.coords.accuracy||0)} m`;
        updateDistances();
      },err=>{
        document.getElementById('gpsStat').textContent = err.message || 'GPS unavailable';
      },{ enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
    } else {
      document.getElementById('gpsStat').textContent = 'Geolocation not supported';
    }

    // ===== Course loading =====
    const state = {
      course:null, iHole:0, // 0-based
      markers:{front:null,mid:null,back:null},
      measure:{line:null, marker:null}
    };

    async function loadCourseList(){
      try {
        const r = await fetch('/courses/index.json');
        if(!r.ok) throw new Error('index.json not found');
        const list = await r.json();
        const sel = document.getElementById('courseSelect');
        sel.innerHTML='';
        list.courses.forEach(c=>{
          const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o);
        });
        document.getElementById('courseCount').textContent = `${list.courses.length} course(s)`;
        document.getElementById('coursePicker').style.display='flex';
      } catch(e){
        document.getElementById('coursePicker').style.display='none';
        alert('No /courses/index.json found. Add courses/ and an index.json to use the picker.');
      }
    }

    async function loadCourseById(id){
      const r = await fetch(`/courses/${id}.json`);
      if(!r.ok){ alert('Course JSON not found'); return; }
      const js = await r.json();
      state.course = js;
      state.iHole = 0;
      document.getElementById('courseName').textContent = js.name || id;
      renderHole();
    }

    function renderHole(){
      if(!state.course) return;
      const hole = state.course.holes[state.iHole];
      document.getElementById('holeTitle').textContent = `Hole ${hole.number}`;
      document.getElementById('holeMeta').textContent = `Par ${hole.par ?? '‚Äì'} ‚Ä¢ Stroke ${hole.strokeIndex ?? '‚Äì'}`;

      // markers
      ['front','mid','back'].forEach(k=>{
        if(state.markers[k]) { map.removeLayer(state.markers[k]); state.markers[k]=null; }
      });

      const mstyle = (k)=> {
        const p={front:['#059669','#10b981'],mid:['#b45309','#f59e0b'],back:['#b91c1c','#ef4444']}[k]||['#111827','#374151'];
        return {radius:7,weight:2,opacity:1,fillOpacity:.9,color:p[0],fillColor:p[1]};
      };

      if(hole.green?.front) state.markers.front = L.circleMarker([hole.green.front.lat, hole.green.front.lng], mstyle('front')).addTo(map).bindTooltip('Front');
      if(hole.green?.mid)   state.markers.mid   = L.circleMarker([hole.green.mid.lat,   hole.green.mid.lng],   mstyle('mid')).addTo(map).bindTooltip('Middle');
      if(hole.green?.back)  state.markers.back  = L.circleMarker([hole.green.back.lat,  hole.green.back.lng],  mstyle('back')).addTo(map).bindTooltip('Back');

      // Fit bounds if we have any points
      const pts=[hole.green?.front, hole.green?.mid, hole.green?.back].filter(Boolean).map(p=>[p.lat,p.lng]);
      if(pts.length) map.fitBounds(L.latLngBounds(pts), { padding:[40,40] });

      updateDistances();
      buildScorecardRows();
    }

    // ===== Distances & elevation deltas =====
    const elD = {
      Front: document.getElementById('dFront'), Mid: document.getElementById('dMid'), Back: document.getElementById('dBack'),
      eFront: document.getElementById('eFront'), eMid: document.getElementById('eMid'), eBack: document.getElementById('eBack')
    };
    function haversine(a,b){
      const toRad=d=>d*Math.PI/180, R=6371000;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const q=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(q));
    }
    function updateDistances(){
      if(!state.course || !lastPos) return;
      const hole = state.course.holes[state.iHole];
      const me = {lat:lastPos.lat, lng:lastPos.lng};

      const upd=(key,label)=>{
        const p = hole.green?.[key];
        const dEl = hole.elevation?.[key];
        const dist = p ? Math.round(haversine(me, p)) : null;
        elD[label].textContent = dist!=null ? `${dist} m` : '‚Äì';
        if(dEl != null){
          // Relative elevation: green point vs current position
          // If your baked values are absolute elevation (meters ASL),
          // you can optionally compute player elevation live. For now just show baked deltas if present.
          elD['e'+label].textContent = `${dEl >= 0 ? '+' : ''}${Math.round(dEl)} m`;
        } else {
          elD['e'+label].textContent = '‚Äì';
        }
      };
      upd('front','Front'); upd('mid','Mid'); upd('back','Back');
    }

    // ===== Measure marker =====
    const measureInfo = document.getElementById('measureInfo');
    const measureText = document.getElementById('measureText');
    const measureClose = document.getElementById('measureClose');

    function setMeasure(latlng){
      // Clear old
      if(state.measure.line){ map.removeLayer(state.measure.line); state.measure.line=null; }
      if(state.measure.marker){ map.removeLayer(state.measure.marker); state.measure.marker=null; }

      if(!latlng) { measureInfo.classList.remove('show'); return; }

      state.measure.marker = L.circleMarker([latlng.lat, latlng.lng], {radius:7, weight:2, color:'#0ea5b7', fillColor:'#67e8f9', fillOpacity:0.9}).addTo(map).bindTooltip('Target');
      if(lastPos){
        state.measure.line = L.polyline([[lastPos.lat,lastPos.lng],[latlng.lat,latlng.lng]], {weight:3, color:'#0ea5b7', opacity:0.9}).addTo(map);
        const d = Math.round(haversine({lat:lastPos.lat,lng:lastPos.lng}, {lat:latlng.lat,lng:latlng.lng}));
        measureText.textContent = `${d} m`;
        measureInfo.classList.add('show');
      }
    }
    document.getElementById('btnMeasure').onclick = () => {
      // enable a one-shot click listener
      const once = (e)=>{ setMeasure(e.latlng); map.off('click', once); };
      map.on('click', once);
    };
    measureClose.onclick = ()=> setMeasure(null);

    // ===== Contours toggle =====
    let contoursOn=false;
    function setContours(on){
      if(on && !contoursOn){
        contours.addTo(map);
        contours.bringToFront && contours.bringToFront();
        document.getElementById('btnContours').classList.add('active');
        contoursOn=true;
      } else if(!on && contoursOn){
        map.removeLayer(contours);
        document.getElementById('btnContours').classList.remove('active');
        contoursOn=false;
      }
    }
    document.getElementById('btnContours').onclick = () => setContours(!contoursOn);

    // ===== Scorecard (minimal shell) =====
    const scEl = document.getElementById('scorecard');
    document.getElementById('btnScore').onclick = () => scEl.classList.add('show');
    document.getElementById('scClose').onclick = () => scEl.classList.remove('show');

    function buildScorecardRows(){
      const box = document.getElementById('scRows');
      if(!state.course){ box.innerHTML=''; return; }
      box.innerHTML='';
      for(const h of state.course.holes){
        const row=document.createElement('div'); row.className='sc-row';
        row.innerHTML = `<div>${h.number}</div><div>${h.par ?? ''}</div>
          <div><input class="sc-score" type="number" min="1" max="15" /></div>
          <div><input class="sc-score" type="number" min="1" max="15" /></div>
          <div><input class="sc-score" type="number" min="1" max="15" /></div>
          <div><input class="sc-score" type="number" min="1" max="15" /></div>`;
        box.appendChild(row);
      }
    }

    // ===== Wind (simple, optional) =====
    async function updateWind(){
      try{
        // Use your current position if available; otherwise center
        const lat = lastPos?.lat ?? map.getCenter().lat;
        const lng = lastPos?.lng ?? map.getCenter().lng;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m`;
        const r = await fetch(url); const j = await r.json();
        const spd = j?.current?.wind_speed_10m; const dir = j?.current?.wind_direction_10m;
        if(typeof spd==='number'){
          document.getElementById('windStat').textContent = `${Math.round(spd)} m/s`;
          // simple arrow icon
          const c = document.getElementById('windIcon');
          c.src = `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><g transform="rotate('+dir+' 12 12)"><path d="M12 3 L16 9 H8 Z" fill="#0ea5b7"/><rect x="11" y="9" width="2" height="10" fill="#0ea5b7"/></g></svg>')}`;
        }
      }catch{}
    }
    setInterval(updateWind, 120000); // every 2 min
    updateWind();

    // ===== Buttons: course picker & hole nav =====
    document.getElementById('btnCourse').onclick = loadCourseList;
    document.getElementById('loadCourse').onclick = ()=>{
      const id = document.getElementById('courseSelect').value;
      if(id) loadCourseById(id);
      document.getElementById('coursePicker').style.display='none';
    };
    document.getElementById('prevHole').onclick = ()=>{ if(!state.course) return; state.iHole = (state.iHole+17)%18; renderHole(); };
    document.getElementById('nextHole').onclick = ()=>{ if(!state.course) return; state.iHole = (state.iHole+1)%18; renderHole(); };

    // ===== Service worker registration (PWA) =====
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
