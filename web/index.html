<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DriveDen GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#14532d" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />

  <style>
    html, body, #map { height:100%; margin:0; }
    body{ font-family: system-ui, sans-serif; }

    .topbar{
      position:fixed; top:10px; left:10px; right:10px;
      display:flex; justify-content:space-between; gap:10px;
      z-index:1001;
    }
    .chip{
      background:#ffffffee; padding:8px 12px; border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .distPanel{ display:flex; gap:12px; }
    .distBox{ min-width:70px; }
    .label{ font-size:12px; color:#555; }
    .big{ font-size:18px; font-weight:700; }

    .fab{
      position:fixed; right:12px; bottom:12px;
      display:flex; flex-direction:column; gap:10px;
      z-index:1001;
    }
    .fab button{
      width:52px; height:52px; border-radius:50%;
      border:0; background:#14532d; color:#fff; font-size:20px;
    }
    .fab-left{
      position:fixed; left:12px; bottom:12px; display:none;
      width:52px; height:52px; border-radius:50%;
      background:#333; color:#fff; border:0;
    }

    .measureInfo{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:80px; display:none;
      background:#ffffffee; padding:6px 10px; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.15); z-index:1001;
    }

    .scorecard{
      position:fixed; left:50%; bottom:80px; transform:translateX(-50%);
      width:min(940px,calc(100% - 20px));
      max-height:70vh; overflow:auto;
      background:#ffffffee; border-radius:12px;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
      padding:12px; z-index:1001; display:none;
    }
    .scorecard.show{ display:block; }
    .sc-row{ display:grid; grid-template-columns: 38px 46px repeat(4, 1fr); gap:8px; align-items:center; padding:4px 0; border-bottom:1px solid #e5e7eb; }
    .sc-head{ font-weight:700; margin-bottom:8px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- TOP -->
  <div class="topbar">
    <div class="chip">
      <div id="holeTitle">Hole ‚Äì</div>
      <div id="holeMeta">Par ‚Äì ‚Ä¢ Stroke ‚Äì</div>
    </div>
    <div class="chip distPanel">
      <div class="distBox"><div class="label">Front</div><div class="big" id="dFront">‚Äì</div></div>
      <div class="distBox"><div class="label">Mid</div><div class="big" id="dMid">‚Äì</div></div>
      <div class="distBox"><div class="label">Back</div><div class="big" id="dBack">‚Äì</div></div>
    </div>
    <div class="chip"><div id="gpsStat">GPS: ‚Ä¶</div></div>
  </div>

  <!-- FAB buttons -->
  <div class="fab">
    <button id="btnScore">üóíÔ∏è</button>
    <button id="btnMeasure">üìè</button>
  </div>
  <button id="recenterBtn" class="fab-left">‚úö</button>

  <!-- Measure info -->
  <div class="measureInfo" id="measureInfo">
    <span id="measureText">0 m</span>
    <button id="measureClose">‚úï</button>
  </div>

  <!-- Scorecard -->
  <div class="scorecard" id="scorecard">
    <div class="sc-head">Scorecard <button id="scClose" style="float:right;">Close</button></div>
    <div class="sc-row" style="font-weight:700;">
      <div>#</div><div>Par</div><div>P1</div><div>P2</div><div>P3</div><div>P4</div>
    </div>
    <div id="scRows"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    // ===== Map =====
    const imagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom:19, attribution:'¬© Esri, Maxar' }
    );
    const map = L.map('map',{layers:[imagery]}).setView([-25.7542,28.2322],16);

    // Cart marker
    const cartSvg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" viewBox="0 0 40 32"><rect x="5" y="10" width="24" height="10" rx="2" ry="2" fill="#1f2937"/><circle cx="13" cy="24" r="4" fill="#111"/><circle cx="27" cy="24" r="4" fill="#111"/></svg>`);
    const you = L.marker([0,0], {icon:L.icon({iconUrl:`data:image/svg+xml;utf8,${cartSvg}`,iconSize:[28,22],iconAnchor:[14,11]})}).addTo(map);

    // Recenter handling
    let follow=true,lastPos=null;
    map.on('dragstart',()=>{follow=false; document.getElementById('recenterBtn').style.display='block';});
    document.getElementById('recenterBtn').onclick=()=>{ if(!lastPos) return; follow=true; map.setView([lastPos.lat,lastPos.lng], map.getZoom()||17); document.getElementById('recenterBtn').style.display='none'; };

    // GPS
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(pos=>{
        lastPos={lat:pos.coords.latitude,lng:pos.coords.longitude};
        you.setLatLng([lastPos.lat,lastPos.lng]);
        if(follow) map.setView([lastPos.lat,lastPos.lng], map.getZoom()||17);
        document.getElementById('gpsStat').textContent=`GPS: ¬±${Math.round(pos.coords.accuracy)} m`;
      },err=>{ document.getElementById('gpsStat').textContent=err.message; },{enableHighAccuracy:true});
    }

    // Measure tool
    const measureInfo=document.getElementById('measureInfo'),
          measureText=document.getElementById('measureText');
    function haversine(a,b){const R=6371000;const toRad=d=>d*Math.PI/180;const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);const q=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;return 2*R*Math.asin(Math.sqrt(q));}
    document.getElementById('btnMeasure').onclick=()=>{
      const once=(e)=>{ if(!lastPos) return; const d=haversine(lastPos,e.latlng); measureText.textContent=`${Math.round(d)} m`; measureInfo.style.display='block'; map.off('click',once); };
      map.on('click',once);
    };
    document.getElementById('measureClose').onclick=()=>{measureInfo.style.display='none';};

    // Scorecard
    const scEl=document.getElementById('scorecard');
    document.getElementById('btnScore').onclick=()=>scEl.classList.add('show');
    document.getElementById('scClose').onclick=()=>scEl.classList.remove('show');
    function buildScorecardRows(){
      const box=document.getElementById('scRows'); box.innerHTML='';
      for(let i=1;i<=18;i++){
        const row=document.createElement('div'); row.className='sc-row';
        row.innerHTML=`<div>${i}</div><div>-</div><div><input type="number"/></div><div><input type="number"/></div><div><input type="number"/></div><div><input type="number"/></div>`;
        box.appendChild(row);
      }
    }
    buildScorecardRows();

    // PWA service worker
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js')); }
  </script>
</body>
</html>
